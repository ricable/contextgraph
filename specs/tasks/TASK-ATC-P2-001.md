# TASK-ATC-P2-001: Discover All Hardcoded Thresholds via Codebase Scan

**Version:** 1.0
**Status:** Ready
**Layer:** Foundation
**Sequence:** 1
**Implements:** REQ-ATC-001 through REQ-ATC-005
**Depends On:** None
**Estimated Complexity:** Medium
**Priority:** P2

---

## Metadata

```yaml
id: TASK-ATC-P2-001
title: Discover All Hardcoded Thresholds via Codebase Scan
status: ready
layer: foundation
sequence: 1
implements:
  - REQ-ATC-001
  - REQ-ATC-002
  - REQ-ATC-003
  - REQ-ATC-004
  - REQ-ATC-005
depends_on: []
estimated_complexity: medium
```

---

## Context

This is the foundational task for the ATC threshold migration. Before any migration can occur, we must have a complete inventory of all hardcoded thresholds in the codebase, categorized by:

1. **Critical (Must Migrate):** Behavioral thresholds that affect consciousness, learning, or decision-making
2. **Should Migrate:** Thresholds that would benefit from domain adaptation
3. **Evaluate:** Thresholds requiring further analysis
4. **Intentionally Static:** Numerical constants that should not be adaptive

The initial grep search identified ~50+ candidate thresholds across multiple modules.

---

## Input Context Files

| File | Purpose |
|------|---------|
| `/home/cabdru/contextgraph/docs/MASTER-CONSCIOUSNESS-GAP-ANALYSIS.md` | Gap analysis mentioning hardcoded thresholds |
| `/home/cabdru/contextgraph/docs2/constitution.yaml` | ATC architecture definition (lines 809-837) |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/atc/mod.rs` | Current ATC implementation |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/atc/domain.rs` | Domain thresholds structure |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/layers/*.rs` | Layer modules with hardcoded thresholds |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/dream/mod.rs` | Dream layer thresholds |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/config/constants.rs` | Alignment threshold constants |
| `/home/cabdru/contextgraph/crates/context-graph-core/src/types/fingerprint/johari/*.rs` | Johari classification thresholds |

---

## Prerequisites

- [ ] Access to full codebase
- [ ] Understanding of ATC 4-level architecture
- [ ] Understanding of domain-specific threshold adaptation

---

## Scope

### In Scope

1. Systematic grep/ripgrep scan for threshold patterns:
   - `const.*THRESHOLD`
   - `const.*MIN_`
   - `const.*MAX_`
   - `: f32 = 0.` or `: f64 = 0.`
   - Comments containing "threshold"

2. Classification of each discovered threshold:
   - Category (critical/should/evaluate/static)
   - Current value
   - File location (file:line)
   - Semantic purpose
   - Domain sensitivity (high/medium/low/none)
   - Proposed ATC field name

3. Generation of threshold inventory document

4. Identification of thresholds already using ATC (for validation)

### Out of Scope

- Actual code migration (subsequent tasks)
- ATC struct modifications (TASK-ATC-P2-002)
- Test updates
- Documentation beyond inventory

---

## Definition of Done

### Deliverables

1. **Threshold Inventory File:** `/home/cabdru/contextgraph/specs/tasks/threshold-inventory.yaml`

```yaml
# Threshold Inventory - Generated by TASK-ATC-P2-001
version: "1.0"
generated_at: "2026-01-11T00:00:00Z"
total_count: <number>

categories:
  critical:
    count: <number>
    thresholds:
      - name: "GW_THRESHOLD"
        file: "crates/context-graph-core/src/layers/coherence.rs"
        line: 60
        current_value: 0.7
        type: "f32"
        purpose: "Global Workspace broadcast gate"
        domain_sensitivity: "high"
        atc_field: "theta_gate"
        rationale: "Determines when memories enter consciousness"

  should_migrate:
    count: <number>
    thresholds: [...]

  evaluate:
    count: <number>
    thresholds: [...]

  static:
    count: <number>
    thresholds: [...]
    rationale_required: true

summary:
  total_thresholds: <number>
  requires_migration: <number>
  already_using_atc: <number>
  intentionally_static: <number>
```

2. **Traceability Matrix:** Update `/home/cabdru/contextgraph/specs/tasks/_traceability.md`

### Constraints

- MUST scan all `/home/cabdru/contextgraph/crates/` subdirectories
- MUST NOT modify any source files
- MUST categorize ALL discovered thresholds (no gaps)
- MUST provide rationale for static classification
- MUST identify domain sensitivity for migratable thresholds

### Verification

```bash
# Verify inventory file syntax
cat specs/tasks/threshold-inventory.yaml | python3 -c "import yaml, sys; yaml.safe_load(sys.stdin)"

# Verify all thresholds are categorized
grep -c "name:" specs/tasks/threshold-inventory.yaml
# Should match total_count in summary

# Verify no new thresholds escaped scanning
rg "const.*THRESHOLD.*f(32|64)" crates/ --count-matches
# Count should be <= inventory count
```

---

## Pseudo Code

```
ALGORITHM: Threshold Discovery Scan

1. SCAN Phase
   FOR each crate in /crates/*/:
     patterns = [
       r"const\s+\w*(THRESHOLD|MIN_|MAX_)\w*\s*:\s*f\d+\s*=",
       r":\s*f(32|64)\s*=\s*0\.\d+",
       r"static\s+\w*THRESHOLD",
       r"#\[.*threshold.*\]"
     ]

     FOR each pattern:
       matches = ripgrep(crate_path, pattern)
       FOR each match:
         threshold = parse_threshold_const(match)
         candidates.append(threshold)

2. DEDUP Phase
   seen = set()
   unique_thresholds = []
   FOR threshold in candidates:
     key = (threshold.file, threshold.line)
     IF key not in seen:
       seen.add(key)
       unique_thresholds.append(threshold)

3. CLASSIFY Phase
   FOR threshold in unique_thresholds:
     IF threshold in ATC_MANAGED:
       threshold.category = "already_atc"
     ELSE IF is_numerical_stability(threshold):
       threshold.category = "static"
       threshold.rationale = "Numerical stability constant"
     ELSE IF affects_consciousness_or_learning(threshold):
       threshold.category = "critical"
       threshold.domain_sensitivity = assess_domain_sensitivity(threshold)
     ELSE IF would_benefit_from_adaptation(threshold):
       threshold.category = "should_migrate"
       threshold.domain_sensitivity = assess_domain_sensitivity(threshold)
     ELSE:
       threshold.category = "evaluate"

4. VALIDATE Phase
   FOR threshold in unique_thresholds:
     IF threshold.category in ["critical", "should_migrate"]:
       ASSERT threshold.atc_field is not None
       ASSERT threshold.domain_sensitivity is not None
     IF threshold.category == "static":
       ASSERT threshold.rationale is not None

5. OUTPUT Phase
   inventory = format_yaml(unique_thresholds)
   write_file("specs/tasks/threshold-inventory.yaml", inventory)
```

---

## Files to Create

| Path | Description |
|------|-------------|
| `/home/cabdru/contextgraph/specs/tasks/threshold-inventory.yaml` | Complete threshold inventory |
| `/home/cabdru/contextgraph/specs/tasks/_traceability.md` | Coverage matrix (create or update) |

---

## Files to Modify

None - this is a discovery task only.

---

## Validation Criteria

| Criterion | Validation Method |
|-----------|-------------------|
| Inventory file is valid YAML | YAML parser check |
| All thresholds categorized | Count verification |
| Critical thresholds have ATC field mapping | Field presence check |
| Static thresholds have rationale | Rationale presence check |
| No duplicate entries | Key uniqueness check |
| Domain sensitivity assessed for migratable | Field presence check |

---

## Test Commands

```bash
# Validate YAML syntax
python3 -c "import yaml; yaml.safe_load(open('specs/tasks/threshold-inventory.yaml'))"

# Count total thresholds discovered
grep -c "^      - name:" specs/tasks/threshold-inventory.yaml

# Verify grep pattern catches known thresholds
rg "GW_THRESHOLD|HYPERSYNC_THRESHOLD|MIN_MEMORY_SIMILARITY" crates/
```

---

## Known Thresholds (Pre-Scan Reference)

From initial grep, the following are expected to be discovered:

### layers/coherence.rs
- `GW_THRESHOLD: f32 = 0.7` (line 60)
- `HYPERSYNC_THRESHOLD: f32 = 0.95` (line 69)
- `FRAGMENTATION_THRESHOLD: f32 = 0.5` (line 72)

### layers/memory.rs
- `MIN_MEMORY_SIMILARITY: f32 = 0.5` (line 52)

### layers/reflex.rs
- `MIN_HIT_SIMILARITY: f32 = 0.85` (line 52)

### layers/learning.rs
- `DEFAULT_CONSOLIDATION_THRESHOLD: f32 = 0.1` (line 47)

### dream/mod.rs
- `ACTIVITY_THRESHOLD: f32 = 0.15` (line 74)
- `MIN_SEMANTIC_LEAP: f32 = 0.7` (line 83)
- `SHORTCUT_CONFIDENCE_THRESHOLD: f32 = 0.7` (line 108)

### config/constants.rs
- `AlignmentThresholds::OPTIMAL: f32 = 0.75` (line 37)
- `AlignmentThresholds::ACCEPTABLE: f32 = 0.70` (line 43)
- `AlignmentThresholds::WARNING: f32 = 0.55` (line 49)
- `BLIND_SPOT_THRESHOLD: f32 = 0.5` (line 114)

### types/fingerprint/johari/core.rs
- `ENTROPY_THRESHOLD: f32 = 0.5` (line 47)
- `COHERENCE_THRESHOLD: f32 = 0.5` (line 50)

### autonomous/services/obsolescence_detector.rs
- `DEFAULT_RELEVANCE_THRESHOLD: f32 = 0.3` (line 17)
- `HIGH_CONFIDENCE_THRESHOLD: f32 = 0.8` (line 20)
- `MEDIUM_CONFIDENCE_THRESHOLD: f32 = 0.6` (line 21)

---

## Notes

- This task is read-only and produces documentation only
- Subsequent tasks will use this inventory for actual migration
- Pay special attention to thresholds in `atc/` module itself - these may be internal to ATC and not need external exposure
- Neuromodulation thresholds are bio-inspired and may warrant "evaluate" classification pending domain expert input

---

**Created:** 2026-01-11
**Author:** Specification Agent
