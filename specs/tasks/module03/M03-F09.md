# Task Specification: M03-F09 (COMPLETE)

## METADATA
| Field | Value |
|-------|-------|
| **Task ID** | M03-F09 |
| **Title** | Define EmbeddingModel Async Trait |
| **Status** | complete |
| **Layer** | foundation |
| **Sequence** | 9 |
| **Implements** | constitution.yaml: embeddings.models, PRD Section 4.3 |
| **Depends On** | M03-F01 (ModelId), M03-F03 (ModelEmbedding), M03-F06 (ModelInput), M03-F07 (InputType), M03-F08 (EmbeddingError) |
| **Estimated Hours** | 2 |
| **Crate** | context-graph-embeddings |
| **Completed** | 2026-01-01 |
| **Verification Commit** | To be set after push |

---

## IMPLEMENTATION STATUS: COMPLETE

This task has been implemented. The `EmbeddingModel` trait is fully functional with 29 passing tests. The implementation follows Phase 0 (Ghost System) patterns - a simplified API without lifecycle management (load/unload) since those require actual GPU weight loading which is deferred to later phases.

---

## ACTUAL IMPLEMENTATION (Source of Truth)

### File Locations
```
crates/context-graph-embeddings/src/
  traits/
    mod.rs               # Module exports
    embedding_model.rs   # Trait definition + 29 tests
  lib.rs                 # Crate root - exports EmbeddingModel
```

### Crate Export (lib.rs, line 36)
```rust
pub use traits::EmbeddingModel;
```

### Trait Definition (traits/embedding_model.rs)

```rust
use async_trait::async_trait;
use crate::error::{EmbeddingError, EmbeddingResult};
use crate::types::{InputType, ModelEmbedding, ModelId, ModelInput};

#[async_trait]
pub trait EmbeddingModel: Send + Sync {
    // ========== REQUIRED METHODS (4) ==========

    /// Returns the unique identifier for this model (E1-E12).
    fn model_id(&self) -> ModelId;

    /// Returns the list of input types this model supports.
    fn supported_input_types(&self) -> &[InputType];

    /// Generate an embedding for the given input.
    /// Returns EmbeddingError::UnsupportedModality if input type not supported.
    /// Returns EmbeddingError::NotInitialized if model not ready.
    async fn embed(&self, input: &ModelInput) -> EmbeddingResult<ModelEmbedding>;

    /// Returns whether the model is initialized and ready for inference.
    fn is_initialized(&self) -> bool;

    // ========== DEFAULT METHODS (7) ==========

    /// Check if this model supports the given input type.
    fn supports_input_type(&self, input_type: InputType) -> bool {
        self.supported_input_types().contains(&input_type)
    }

    /// Returns the native output dimension (delegates to ModelId::dimension()).
    fn dimension(&self) -> usize {
        self.model_id().dimension()
    }

    /// Returns the projected dimension for FuseMoE input.
    fn projected_dimension(&self) -> usize {
        self.model_id().projected_dimension()
    }

    /// Returns the latency budget in milliseconds (constitution.yaml targets).
    fn latency_budget_ms(&self) -> u32 {
        self.model_id().latency_budget_ms()
    }

    /// Validate that input is compatible with this model.
    fn validate_input(&self, input: &ModelInput) -> EmbeddingResult<()> {
        let input_type = InputType::from(input);
        if self.supports_input_type(input_type) {
            Ok(())
        } else {
            Err(EmbeddingError::UnsupportedModality {
                model_id: self.model_id(),
                input_type,
            })
        }
    }

    /// Returns the maximum input token count.
    fn max_tokens(&self) -> usize {
        self.model_id().max_tokens()
    }

    /// Returns whether this model uses pretrained weights.
    fn is_pretrained(&self) -> bool {
        self.model_id().is_pretrained()
    }
}
```

---

## VERIFICATION EVIDENCE

### Test Results (29 tests passing)
```bash
cargo test -p context-graph-embeddings embedding_model -- --nocapture

running 29 tests
test traits::embedding_model::tests::test_model_id_returns_correct_value ... ok
test traits::embedding_model::tests::test_model_id_for_all_12_models ... ok
test traits::embedding_model::tests::test_model_id_is_consistent_across_calls ... ok
test traits::embedding_model::tests::test_supported_input_types_returns_correct_list ... ok
test traits::embedding_model::tests::test_supports_input_type_true_for_supported ... ok
test traits::embedding_model::tests::test_supports_input_type_false_for_unsupported ... ok
test traits::embedding_model::tests::test_embed_returns_correct_model_id ... ok
test traits::embedding_model::tests::test_embed_returns_correct_dimension ... ok
test traits::embedding_model::tests::test_embed_rejects_unsupported_input_type ... ok
test traits::embedding_model::tests::test_embed_rejects_when_not_initialized ... ok
test traits::embedding_model::tests::test_embed_deterministic_for_same_input ... ok
test traits::embedding_model::tests::test_is_initialized_returns_true_by_default ... ok
test traits::embedding_model::tests::test_is_initialized_reflects_state_change ... ok
test traits::embedding_model::tests::test_dimension_delegates_to_model_id ... ok
test traits::embedding_model::tests::test_projected_dimension_delegates_to_model_id ... ok
test traits::embedding_model::tests::test_latency_budget_ms_delegates_to_model_id ... ok
test traits::embedding_model::tests::test_max_tokens_delegates_to_model_id ... ok
test traits::embedding_model::tests::test_is_pretrained_delegates_to_model_id ... ok
test traits::embedding_model::tests::test_validate_input_accepts_supported_type ... ok
test traits::embedding_model::tests::test_validate_input_rejects_unsupported_type ... ok
test traits::embedding_model::tests::test_embedding_model_is_send ... ok
test traits::embedding_model::tests::test_embedding_model_is_sync ... ok
test traits::embedding_model::tests::test_trait_is_object_safe ... ok
test traits::embedding_model::tests::test_model_can_be_shared_across_tasks ... ok
test traits::embedding_model::tests::test_all_12_models_produce_correct_dimensions ... ok
test traits::embedding_model::tests::test_all_input_types_can_be_supported ... ok
test traits::embedding_model::tests::test_dyn_trait_reference_works ... ok
test traits::embedding_model::tests::test_multiple_model_instances_independent ... ok
test traits::embedding_model::tests::test_supported_types_can_use_hashset ... ok

test result: ok. 29 passed; 0 failed
```

### Compilation Check
```bash
cargo check -p context-graph-embeddings  # Passes with no errors/warnings
cargo clippy -p context-graph-embeddings -- -D warnings  # Clean
```

---

## TYPE DEPENDENCIES (All Verified)

| Type | Location | Status |
|------|----------|--------|
| ModelId | `crate::types::model_id` | 12 variants (Semantic through LateInteraction) |
| ModelEmbedding | `crate::types::embedding` | Has `model_id`, `vector`, `latency_us` fields |
| ModelInput | `crate::types::input` | 4 variants: Text, Code, Image, Audio |
| InputType | `crate::types::input` | Discriminator enum (4 variants) |
| EmbeddingError | `crate::error` | 17 variants across 6 categories |
| EmbeddingResult<T> | `crate::error` | `Result<T, EmbeddingError>` alias |

---

## DESIGN DECISIONS

### Why No `load()`/`unload()` Methods?
Phase 0 (Ghost System) uses `StubEmbedder` which doesn't load real weights. Lifecycle management deferred to Phase 2 (Embedding Pipeline) when actual HuggingFace models are integrated. Adding now would require mock implementations that mask real issues.

### Why `is_initialized()` Instead of `is_loaded()`?
"Initialized" is more accurate for Phase 0 - models can be "ready" without loading weights. The name change maintains semantic clarity without implying weight loading occurred.

### Why `supported_input_types()` Instead of `supported_inputs()`?
Clearer name - returns `&[InputType]`, not `&[ModelInput]`. Explicit about what's being returned.

---

## TRAIT BOUNDS VERIFICATION

```rust
#[test]
fn test_embedding_model_is_send() {
    fn assert_send<T: Send>() {}
    assert_send::<dyn EmbeddingModel>();  // COMPILES
}

#[test]
fn test_embedding_model_is_sync() {
    fn assert_sync<T: Sync>() {}
    assert_sync::<dyn EmbeddingModel>();  // COMPILES
}

#[test]
fn test_trait_is_object_safe() {
    // EmbeddingModel can be used as Box<dyn EmbeddingModel>
    let model: Box<dyn EmbeddingModel> = Box::new(TestModel::new(...));
    assert!(model.is_initialized());  // WORKS
}
```

---

## FUTURE EXTENSIONS (Phase 2+)

When implementing actual model loading, extend the trait with:

```rust
// NOT YET IMPLEMENTED - Future work for M03-L01 through M03-L14
async fn load(&self) -> EmbeddingResult<()>;
async fn unload(&self) -> EmbeddingResult<()>;
fn memory_usage_bytes(&self) -> usize;
fn warmup_complete(&self) -> bool;

// For batch optimization
async fn embed_batch(&self, inputs: &[ModelInput]) -> EmbeddingResult<Vec<ModelEmbedding>> {
    // Default sequential implementation
    let mut results = Vec::with_capacity(inputs.len());
    for input in inputs {
        results.push(self.embed(input).await?);
    }
    Ok(results)
}
```

These are NOT blockers for M03-F09 completion - they will be added in Phase 2 Logic Layer tasks.

---

## USAGE EXAMPLE

```rust
use context_graph_embeddings::{EmbeddingModel, types::{ModelInput, ModelId}};
use std::sync::Arc;

async fn example(model: Arc<dyn EmbeddingModel>) -> Result<(), Box<dyn std::error::Error>> {
    // Check capabilities
    if model.supports_input_type(InputType::Code) {
        let input = ModelInput::code("fn main() {}", "rust")?;
        let embedding = model.embed(&input).await?;
        assert_eq!(embedding.model_id, model.model_id());
        assert_eq!(embedding.dimension(), model.dimension());
    }
    Ok(())
}
```

---

## FINAL CHECKLIST (All Complete)

- [x] `cargo check -p context-graph-embeddings` passes
- [x] `cargo test -p context-graph-embeddings` passes (273+ tests total, 29 trait-specific)
- [x] `cargo clippy -p context-graph-embeddings -- -D warnings` clean
- [x] Trait is `Send + Sync` (verified by compile-time tests)
- [x] Trait is object-safe (verified by `Box<dyn EmbeddingModel>` test)
- [x] Exported from crate root as `pub use traits::EmbeddingModel`
- [x] All imports use `crate::` paths
- [x] Error returns use `EmbeddingError` variants from M03-F08
- [x] Tests use real types (ModelInput, ModelEmbedding) - NO mocks
- [x] Concurrent usage test passes (10 parallel tasks)

---

*Task Completed: 2026-01-01*
*Module: 03 - 12-Model Embedding Pipeline*
*Version: 3.0.0 (Updated to reflect actual implementation)*
