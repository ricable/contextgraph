# TASK-M02-020: Complete SuggestedAction Enum

## Task Metadata
| Field | Value |
|-------|-------|
| Task ID | TASK-M02-020 |
| Status | **READY** |
| Layer | surface |
| Module | module-02 |
| Priority | high |
| Estimated Hours | 0.5 |
| Depends On | None (standalone enum) |
| Implements | TECH-CORE-002 Section 2.4, REQ-CORE-008 |

---

## Current State Analysis (as of 2025-12-31)

### What Already Exists
**File:** `crates/context-graph-core/src/types/pulse.rs` (lines 102-138)

```rust
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq, Hash)]
#[serde(rename_all = "snake_case")]
pub enum SuggestedAction {
    Ready,
    Continue,
    Explore,
    Consolidate,
    Prune,
    Stabilize,
    Review,
}

impl SuggestedAction {
    pub fn description(&self) -> &'static str { /* implemented */ }
}
```

### What Is MISSING
1. **`Default` trait implementation** - Required by spec: `Default` must return `Continue`
2. **Enhanced doc comments** - Current descriptions are generic, spec requires actionable MCP tool guidance
3. **Complete test coverage** - Missing tests for: default, serde roundtrip, unique descriptions

### What Is CORRECT
- All 7 variants present ✅
- `description()` method exists ✅
- Serde with snake_case ✅
- Clone, Copy, Debug, PartialEq, Eq, Hash derives ✅
- Location in `types/pulse.rs` (re-exported via `types/mod.rs`) ✅

---

## Exact Changes Required

### 1. Add Default Derive (pulse.rs line 106)

**Current:**
```rust
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq, Hash)]
```

**Change to:**
```rust
#[derive(Debug, Clone, Copy, Default, Serialize, Deserialize, PartialEq, Eq, Hash)]
```

AND add `#[default]` attribute to `Continue` variant:
```rust
pub enum SuggestedAction {
    Ready,
    #[default]
    Continue,
    // ... rest
}
```

### 2. Enhance Description Method

Replace the current `description()` implementation with actionable guidance:

```rust
impl SuggestedAction {
    /// Returns a human-readable description with MCP tool guidance.
    pub fn description(&self) -> &'static str {
        match self {
            Self::Ready => "System ready for new input - low entropy, high coherence",
            Self::Continue => "Continue current activity - balanced state",
            Self::Explore => "Explore new knowledge - use epistemic_action or trigger_dream(rem)",
            Self::Consolidate => "Consolidate knowledge - use trigger_dream(nrem) or merge_concepts",
            Self::Prune => "Prune redundant information - review curation_tasks",
            Self::Stabilize => "Stabilize context - use trigger_dream or critique_context",
            Self::Review => "Review context - use critique_context or reflect_on_memory",
        }
    }
}
```

### 3. Add Required Tests

Add these tests to the existing `#[cfg(test)]` module in pulse.rs:

```rust
#[test]
fn test_suggested_action_default_is_continue() {
    let action = SuggestedAction::default();
    assert_eq!(action, SuggestedAction::Continue);
}

#[test]
fn test_suggested_action_serde_roundtrip() {
    let actions = [
        SuggestedAction::Ready,
        SuggestedAction::Continue,
        SuggestedAction::Explore,
        SuggestedAction::Consolidate,
        SuggestedAction::Prune,
        SuggestedAction::Stabilize,
        SuggestedAction::Review,
    ];
    for action in actions {
        let json = serde_json::to_string(&action).unwrap();
        let parsed: SuggestedAction = serde_json::from_str(&json).unwrap();
        assert_eq!(action, parsed);
    }
}

#[test]
fn test_suggested_action_serde_snake_case() {
    // Verify snake_case serialization
    let json = serde_json::to_string(&SuggestedAction::Ready).unwrap();
    assert_eq!(json, "\"ready\"");

    let json = serde_json::to_string(&SuggestedAction::Continue).unwrap();
    assert_eq!(json, "\"continue\"");
}

#[test]
fn test_suggested_action_descriptions_not_empty() {
    let actions = [
        SuggestedAction::Ready,
        SuggestedAction::Continue,
        SuggestedAction::Explore,
        SuggestedAction::Consolidate,
        SuggestedAction::Prune,
        SuggestedAction::Stabilize,
        SuggestedAction::Review,
    ];
    for action in actions {
        let desc = action.description();
        assert!(!desc.is_empty(), "{:?} has empty description", action);
        assert!(desc.len() > 20, "{:?} description too short: {}", action, desc);
    }
}

#[test]
fn test_suggested_action_descriptions_unique() {
    use std::collections::HashSet;
    let actions = [
        SuggestedAction::Ready,
        SuggestedAction::Continue,
        SuggestedAction::Explore,
        SuggestedAction::Consolidate,
        SuggestedAction::Prune,
        SuggestedAction::Stabilize,
        SuggestedAction::Review,
    ];
    let descriptions: HashSet<_> = actions.iter().map(|a| a.description()).collect();
    assert_eq!(descriptions.len(), actions.len(), "Descriptions must be unique");
}

#[test]
fn test_suggested_action_copy_semantics() {
    let action = SuggestedAction::Explore;
    let copied = action; // Copy, not move
    assert_eq!(action, copied);
    assert_eq!(action.description(), copied.description());
}

#[test]
fn test_suggested_action_hash() {
    use std::collections::HashSet;
    let mut set = HashSet::new();
    set.insert(SuggestedAction::Ready);
    set.insert(SuggestedAction::Continue);
    set.insert(SuggestedAction::Ready); // duplicate
    assert_eq!(set.len(), 2);
}
```

---

## File Paths (VERIFIED)

| File | Action |
|------|--------|
| `crates/context-graph-core/src/types/pulse.rs` | Modify (add Default, enhance descriptions, add tests) |
| `crates/context-graph-core/src/types/mod.rs` | No change needed (already re-exports via `pub use pulse::*`) |
| `crates/context-graph-core/src/lib.rs` | No change needed (SuggestedAction accessible via `types::SuggestedAction`) |

---

## Verification Commands

```bash
# 1. Build check
cargo build --package context-graph-core

# 2. Run SuggestedAction tests
cargo test --package context-graph-core suggested_action -- --nocapture

# 3. Run all pulse tests
cargo test --package context-graph-core pulse -- --nocapture

# 4. Clippy check
cargo clippy --package context-graph-core -- -D warnings

# 5. Verify Default trait works
cargo test --package context-graph-core test_suggested_action_default -- --nocapture
```

---

## Definition of Done

### Required Signatures
```rust
// In crates/context-graph-core/src/types/pulse.rs

#[derive(Debug, Clone, Copy, Default, Serialize, Deserialize, PartialEq, Eq, Hash)]
#[serde(rename_all = "snake_case")]
pub enum SuggestedAction {
    Ready,
    #[default]
    Continue,
    Explore,
    Consolidate,
    Prune,
    Stabilize,
    Review,
}

impl SuggestedAction {
    pub fn description(&self) -> &'static str;
}
```

### Constraints
- [x] All 7 variants present
- [ ] Default returns Continue
- [ ] Serde uses snake_case
- [ ] Descriptions include MCP tool guidance
- [ ] All tests pass

---

## Action Decision Matrix Reference

From PRD Section 1.3, suggested actions map to entropy (E) and coherence (C):

| E | C | Action | MCP Tools |
|---|---|--------|-----------|
| >0.7 | >0.5 | Explore | `epistemic_action`, `trigger_dream(rem)` |
| >0.7 | <0.4 | Stabilize | `trigger_dream`, `critique_context` |
| <0.4 | >0.7 | Ready | Continue normal operation |
| <0.4 | <0.4 | Review | `get_neighborhood`, `critique_context` |
| 0.4-0.7 | 0.4-0.7 | Continue | Balanced state |

This decision logic is implemented in `CognitivePulse::compute_action()` (TASK-M02-022), NOT in this task.

---

## Full State Verification Protocol

After completing the implementation, you MUST perform these verification steps:

### 1. Source of Truth Identification
The source of truth is the compiled Rust code in `crates/context-graph-core/src/types/pulse.rs`. Verification proves the enum exists with correct behavior.

### 2. Execute & Inspect

```bash
# Run tests and capture output
cargo test --package context-graph-core pulse -- --nocapture 2>&1 | tee /tmp/pulse-test-output.txt

# Verify Default trait works
echo "
use context_graph_core::types::SuggestedAction;
fn main() {
    let default = SuggestedAction::default();
    println!(\"Default SuggestedAction: {:?}\", default);
    assert_eq!(default, SuggestedAction::Continue);
    println!(\"VERIFIED: Default is Continue\");
}" | cargo run --package context-graph-core --example verify_default 2>/dev/null || echo "Create verify_default.rs example"
```

### 3. Boundary & Edge Case Audit

Test these 3 edge cases with before/after state logging:

**Edge Case 1: Default Trait**
```rust
// Before: SuggestedAction::default() should not compile (no Default)
// After: SuggestedAction::default() == SuggestedAction::Continue
let before = "SuggestedAction has no Default impl";
let action = SuggestedAction::default();
let after = format!("SuggestedAction::default() = {:?}", action);
assert_eq!(action, SuggestedAction::Continue);
println!("Edge Case 1 PASS: {} -> {}", before, after);
```

**Edge Case 2: Serde Roundtrip with Unknown Variant**
```rust
// Before: Parse "\"unknown_action\"" should fail
// After: Error returned, no panic
let json = "\"unknown_action\"";
let result: Result<SuggestedAction, _> = serde_json::from_str(json);
assert!(result.is_err());
println!("Edge Case 2 PASS: Invalid variant correctly rejected");
```

**Edge Case 3: HashSet Deduplication**
```rust
// Before: No guarantee HashSet works
// After: HashSet correctly deduplicates
use std::collections::HashSet;
let mut set = HashSet::new();
set.insert(SuggestedAction::Ready);
set.insert(SuggestedAction::Ready);
assert_eq!(set.len(), 1);
println!("Edge Case 3 PASS: HashSet deduplication works");
```

### 4. Evidence of Success

After all tests pass, provide this log output as proof:

```
=== TASK-M02-020 Verification Report ===
Date: [timestamp]
Commit: [git hash]

1. BUILD: cargo build --package context-graph-core [SUCCESS]
2. TESTS: cargo test --package context-graph-core pulse [X passed, 0 failed]
3. CLIPPY: cargo clippy --package context-graph-core [0 warnings]

4. MANUAL VERIFICATION:
   - SuggestedAction::default() == Continue: VERIFIED
   - All 7 variants serialize to snake_case: VERIFIED
   - All descriptions contain MCP tool guidance: VERIFIED
   - Hash/Eq traits work correctly: VERIFIED

5. EDGE CASES:
   - Default trait: PASS
   - Invalid serde: PASS
   - HashSet dedup: PASS

=== TASK-M02-020 COMPLETE ===
```

---

## Final Verification: Sherlock-Holmes Agent

**MANDATORY**: After completing all implementation and tests, spawn the `sherlock-holmes` subagent to perform forensic verification:

```
Task(
  "Verify TASK-M02-020 SuggestedAction implementation",
  "Investigate crates/context-graph-core/src/types/pulse.rs for SuggestedAction enum.
   VERIFY:
   1. Default derive exists and #[default] on Continue variant
   2. All 7 variants present: Ready, Continue, Explore, Consolidate, Prune, Stabilize, Review
   3. description() returns actionable strings with MCP tool names
   4. Serde with snake_case works
   5. All tests pass: cargo test --package context-graph-core pulse
   6. No clippy warnings

   Report any discrepancies. This enum is GUILTY UNTIL PROVEN INNOCENT.",
  "sherlock-holmes"
)
```

If Sherlock identifies ANY issues, fix them before marking this task complete.

---

## NOT In Scope (Explicitly Excluded)

| Item | Why Excluded | Where Covered |
|------|--------------|---------------|
| EmotionalState enum | Separate type in types/utl.rs | TASK-M02-019 |
| CognitivePulse struct | Uses SuggestedAction but defined separately | TASK-M02-021 |
| compute_suggested_action() | Business logic, not enum definition | TASK-M02-022 |
| Re-export changes | Already done via `pub use pulse::*` | N/A |

---

*Task ID: TASK-M02-020*
*Module: 02 - Core Infrastructure*
*Layer: Surface*
*Last Updated: 2025-12-31*
