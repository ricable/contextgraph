# TASK-M02-009: Define EdgeType Enum in Marblestone Module

## TASK STATUS: READY

## CRITICAL CONTEXT FOR IMPLEMENTING AGENT

**READ THIS FIRST**: EdgeType already exists in `crates/context-graph-core/src/types/graph_edge.rs` with 7 variants. This task requires **replacing/migrating** that to `marblestone.rs` with the canonical 4 variants per constitution.yaml. NO BACKWARDS COMPATIBILITY - the old location must be removed.

---

## 1. Current Codebase State (Verified 2025-12-31)

### 1.1 Existing EdgeType (TO BE REMOVED)
**File**: `crates/context-graph-core/src/types/graph_edge.rs` (lines 55-73)
```rust
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq, Hash)]
#[serde(rename_all = "snake_case")]
pub enum EdgeType {
    Semantic,
    Temporal,
    Causal,
    Hierarchical,
    Associative,    // NOT in constitution - REMOVE
    Contradicts,    // NOT in constitution - REMOVE
    Supports,       // NOT in constitution - REMOVE
}
```

### 1.2 Target Location
**File**: `crates/context-graph-core/src/marblestone.rs`

**Current contents**: Domain enum (lines 35-56) + NeurotransmitterWeights struct (lines 162-310)
**Line count**: 850 lines (including tests)
**Test status**: 66 tests passing, 0 clippy warnings

### 1.3 Constitution Reference (Source of Truth)
From `docs2/constitution.yaml` line 173:
```yaml
edge_model:
  attrs: [source:UUID, target:UUID, type:Semantic|Temporal|Causal|Hierarchical|Relational, ...]
```

**Note**: Constitution lists 5 types including `Relational`. The PRD Section 4.2 lists the same 4 core types. `Relational` is for `priors_vibe_check` edges (future task).

---

## 2. Exact Requirements

### 2.1 Create EdgeType Enum in marblestone.rs

**Location**: Append after NeurotransmitterWeights tests (~line 850)

```rust
/// Type of relationship between two nodes in the graph.
///
/// Each edge type represents a distinct semantic relationship with
/// different traversal and weighting characteristics:
/// - Semantic: Similarity-based connections
/// - Temporal: Time-ordered sequences
/// - Causal: Cause-effect relationships
/// - Hierarchical: Parent-child taxonomies
///
/// # Constitution Reference
/// - edge_model.attrs: type:Semantic|Temporal|Causal|Hierarchical
///
/// # Example
/// ```rust
/// use context_graph_core::marblestone::EdgeType;
///
/// let edge = EdgeType::Causal;
/// assert_eq!(edge.to_string(), "causal");
/// assert_eq!(edge.default_weight(), 0.8);
/// ```
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum EdgeType {
    /// Semantic similarity relationship.
    /// Nodes share similar meaning, topic, or conceptual space.
    Semantic,

    /// Temporal sequence relationship.
    /// Source node occurred before target node in time.
    Temporal,

    /// Causal relationship.
    /// Source node causes, influences, or triggers target node.
    Causal,

    /// Hierarchical relationship.
    /// Source node is a parent, category, or ancestor of target node.
    Hierarchical,
}

impl EdgeType {
    /// Returns a human-readable description of this edge type.
    pub fn description(&self) -> &'static str {
        match self {
            Self::Semantic => "Semantic similarity - nodes share similar meaning or topic",
            Self::Temporal => "Temporal sequence - source precedes target in time",
            Self::Causal => "Causal relationship - source causes or influences target",
            Self::Hierarchical => "Hierarchical - source is parent or ancestor of target",
        }
    }

    /// Returns all edge type variants as an array.
    pub fn all() -> [EdgeType; 4] {
        [Self::Semantic, Self::Temporal, Self::Causal, Self::Hierarchical]
    }

    /// Returns the default base weight for this edge type.
    ///
    /// These weights reflect the inherent reliability of each relationship type:
    /// - Semantic (0.5): Variable based on embedding similarity
    /// - Temporal (0.7): Time relationships are usually reliable
    /// - Causal (0.8): Strong evidence when established
    /// - Hierarchical (0.9): Taxonomy relationships are very strong
    pub fn default_weight(&self) -> f32 {
        match self {
            Self::Semantic => 0.5,
            Self::Temporal => 0.7,
            Self::Causal => 0.8,
            Self::Hierarchical => 0.9,
        }
    }
}

impl Default for EdgeType {
    /// Returns `EdgeType::Semantic` as the default.
    /// Semantic is the most common edge type in knowledge graphs.
    fn default() -> Self {
        Self::Semantic
    }
}

impl std::fmt::Display for EdgeType {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        let s = match self {
            Self::Semantic => "semantic",
            Self::Temporal => "temporal",
            Self::Causal => "causal",
            Self::Hierarchical => "hierarchical",
        };
        write!(f, "{}", s)
    }
}
```

### 2.2 Required Tests (append to marblestone.rs tests module)

```rust
// =========================================================================
// EdgeType Tests
// =========================================================================

// --- Default Tests ---
#[test]
fn test_edge_type_default_is_semantic() {
    assert_eq!(EdgeType::default(), EdgeType::Semantic);
}

// --- Description Tests ---
#[test]
fn test_edge_type_description_non_empty() {
    for edge_type in EdgeType::all() {
        let desc = edge_type.description();
        assert!(!desc.is_empty(), "Description for {:?} is empty", edge_type);
        assert!(desc.len() > 10, "Description for {:?} too short", edge_type);
    }
}

#[test]
fn test_edge_type_semantic_description() {
    assert!(EdgeType::Semantic.description().to_lowercase().contains("similar"));
}

#[test]
fn test_edge_type_temporal_description() {
    assert!(EdgeType::Temporal.description().to_lowercase().contains("time"));
}

#[test]
fn test_edge_type_causal_description() {
    assert!(EdgeType::Causal.description().to_lowercase().contains("cause"));
}

#[test]
fn test_edge_type_hierarchical_description() {
    assert!(EdgeType::Hierarchical.description().to_lowercase().contains("parent"));
}

// --- all() Tests ---
#[test]
fn test_edge_type_all_returns_4_variants() {
    assert_eq!(EdgeType::all().len(), 4);
}

#[test]
fn test_edge_type_all_contains_all_variants() {
    let all = EdgeType::all();
    assert!(all.contains(&EdgeType::Semantic));
    assert!(all.contains(&EdgeType::Temporal));
    assert!(all.contains(&EdgeType::Causal));
    assert!(all.contains(&EdgeType::Hierarchical));
}

#[test]
fn test_edge_type_all_order() {
    let all = EdgeType::all();
    assert_eq!(all[0], EdgeType::Semantic);
    assert_eq!(all[1], EdgeType::Temporal);
    assert_eq!(all[2], EdgeType::Causal);
    assert_eq!(all[3], EdgeType::Hierarchical);
}

// --- default_weight() Tests ---
#[test]
fn test_edge_type_default_weight_semantic() {
    assert!((EdgeType::Semantic.default_weight() - 0.5).abs() < 0.001);
}

#[test]
fn test_edge_type_default_weight_temporal() {
    assert!((EdgeType::Temporal.default_weight() - 0.7).abs() < 0.001);
}

#[test]
fn test_edge_type_default_weight_causal() {
    assert!((EdgeType::Causal.default_weight() - 0.8).abs() < 0.001);
}

#[test]
fn test_edge_type_default_weight_hierarchical() {
    assert!((EdgeType::Hierarchical.default_weight() - 0.9).abs() < 0.001);
}

#[test]
fn test_edge_type_weights_in_valid_range() {
    for edge_type in EdgeType::all() {
        let weight = edge_type.default_weight();
        assert!(weight >= 0.0 && weight <= 1.0,
            "Weight {} for {:?} out of range", weight, edge_type);
    }
}

#[test]
fn test_edge_type_weights_increasing_strength() {
    // Hierarchical > Causal > Temporal > Semantic
    assert!(EdgeType::Hierarchical.default_weight() > EdgeType::Causal.default_weight());
    assert!(EdgeType::Causal.default_weight() > EdgeType::Temporal.default_weight());
    assert!(EdgeType::Temporal.default_weight() > EdgeType::Semantic.default_weight());
}

// --- Display Tests ---
#[test]
fn test_edge_type_display_semantic() {
    assert_eq!(EdgeType::Semantic.to_string(), "semantic");
}

#[test]
fn test_edge_type_display_temporal() {
    assert_eq!(EdgeType::Temporal.to_string(), "temporal");
}

#[test]
fn test_edge_type_display_causal() {
    assert_eq!(EdgeType::Causal.to_string(), "causal");
}

#[test]
fn test_edge_type_display_hierarchical() {
    assert_eq!(EdgeType::Hierarchical.to_string(), "hierarchical");
}

#[test]
fn test_edge_type_display_all_lowercase() {
    for edge_type in EdgeType::all() {
        let s = edge_type.to_string();
        assert_eq!(s, s.to_lowercase(), "Display for {:?} not lowercase", edge_type);
    }
}

// --- Serde Tests ---
#[test]
fn test_edge_type_serde_snake_case() {
    let edge = EdgeType::Semantic;
    let json = serde_json::to_string(&edge).unwrap();
    assert_eq!(json, r#""semantic""#);
}

#[test]
fn test_edge_type_serde_roundtrip() {
    for edge_type in EdgeType::all() {
        let json = serde_json::to_string(&edge_type).unwrap();
        let restored: EdgeType = serde_json::from_str(&json).unwrap();
        assert_eq!(edge_type, restored, "Roundtrip failed for {:?}", edge_type);
    }
}

#[test]
fn test_edge_type_serde_deserialize() {
    let edge: EdgeType = serde_json::from_str(r#""causal""#).unwrap();
    assert_eq!(edge, EdgeType::Causal);
}

// --- Derive Trait Tests ---
#[test]
fn test_edge_type_clone() {
    let edge = EdgeType::Temporal;
    let cloned = edge.clone();
    assert_eq!(edge, cloned);
}

#[test]
fn test_edge_type_copy() {
    let edge = EdgeType::Causal;
    let copied = edge;
    assert_eq!(edge, copied);
    let _still_valid = edge; // Proves Copy
}

#[test]
fn test_edge_type_debug() {
    let debug = format!("{:?}", EdgeType::Hierarchical);
    assert!(debug.contains("Hierarchical"));
}

#[test]
fn test_edge_type_partial_eq() {
    assert_eq!(EdgeType::Semantic, EdgeType::Semantic);
    assert_ne!(EdgeType::Semantic, EdgeType::Temporal);
}

#[test]
fn test_edge_type_hash() {
    use std::collections::HashSet;
    let mut set = HashSet::new();
    set.insert(EdgeType::Semantic);
    set.insert(EdgeType::Temporal);
    set.insert(EdgeType::Semantic); // Duplicate
    assert_eq!(set.len(), 2);
}

// --- Edge Cases ---
#[test]
fn test_edge_type_all_unique() {
    use std::collections::HashSet;
    let all = EdgeType::all();
    let unique: HashSet<_> = all.iter().collect();
    assert_eq!(unique.len(), 4);
}

#[test]
fn test_edge_type_default_in_all() {
    assert!(EdgeType::all().contains(&EdgeType::default()));
}
```

### 2.3 Update lib.rs Re-exports

**File**: `crates/context-graph-core/src/lib.rs`
**Current line 31**:
```rust
pub use marblestone::{Domain, NeurotransmitterWeights};
```
**Change to**:
```rust
pub use marblestone::{Domain, EdgeType, NeurotransmitterWeights};
```

### 2.4 Update graph_edge.rs to Use Marblestone EdgeType

**File**: `crates/context-graph-core/src/types/graph_edge.rs`

**DELETE lines 55-73** (the local EdgeType enum)

**ADD import at top** (after existing imports):
```rust
use crate::marblestone::EdgeType;
```

**KEEP the existing GraphEdge struct** - it will now use the imported EdgeType.

---

## 3. File Changes Summary

| File | Action | Details |
|------|--------|---------|
| `crates/context-graph-core/src/marblestone.rs` | APPEND | Add EdgeType enum + impl + tests after line 849 |
| `crates/context-graph-core/src/lib.rs` | MODIFY | Add EdgeType to re-exports on line 31 |
| `crates/context-graph-core/src/types/graph_edge.rs` | MODIFY | Remove local EdgeType (lines 55-73), add import |

---

## 4. Validation Commands (MUST ALL PASS)

```bash
# Build
cargo build --package context-graph-core

# Run all tests including new edge_type tests
cargo test --package context-graph-core -- --nocapture

# Run only edge_type tests
cargo test --package context-graph-core edge_type -- --nocapture

# Clippy must show 0 warnings
cargo clippy --package context-graph-core -- -D warnings
```

**Expected Results**:
- Build: SUCCESS
- Tests: 100+ tests passing (66 existing + ~35 new EdgeType tests)
- Clippy: 0 warnings

---

## 5. Full State Verification (MANDATORY)

### 5.1 Source of Truth
The EdgeType enum is the authoritative definition. After implementation:
- `EdgeType::all()` returns exactly 4 variants
- Each variant has a valid description, default_weight, Display impl
- Serde serializes to snake_case JSON strings
- The old EdgeType in graph_edge.rs is REMOVED (not duplicated)

### 5.2 Execute & Inspect Protocol
After implementing, run these verification steps:

```bash
# 1. Verify EdgeType exists in marblestone.rs
grep -n "pub enum EdgeType" crates/context-graph-core/src/marblestone.rs

# 2. Verify EdgeType REMOVED from graph_edge.rs
grep -n "pub enum EdgeType" crates/context-graph-core/src/types/graph_edge.rs
# Expected: NO OUTPUT (if found, task FAILED)

# 3. Verify import added to graph_edge.rs
grep -n "use crate::marblestone::EdgeType" crates/context-graph-core/src/types/graph_edge.rs

# 4. Verify re-export in lib.rs
grep -n "EdgeType" crates/context-graph-core/src/lib.rs

# 5. Count tests
cargo test --package context-graph-core edge_type 2>&1 | grep -E "^test.*ok$" | wc -l
# Expected: 35 or more

# 6. Verify GraphEdge still compiles with new EdgeType
cargo test --package context-graph-core graph_edge -- --nocapture
```

### 5.3 Boundary & Edge Case Audit

**Test Case 1: Empty variant handling**
```rust
// Run this in tests - verify all() is not empty
assert!(!EdgeType::all().is_empty());
```

**Test Case 2: Weight boundaries**
```rust
// Verify weights are in [0.0, 1.0]
for edge in EdgeType::all() {
    let w = edge.default_weight();
    assert!(w >= 0.0 && w <= 1.0);
}
```

**Test Case 3: Serde edge cases**
```rust
// Invalid variant should fail
let result: Result<EdgeType, _> = serde_json::from_str(r#""invalid""#);
assert!(result.is_err());
```

### 5.4 Evidence of Success Log
After all tests pass, the output should show:
```
test marblestone::tests::test_edge_type_default_is_semantic ... ok
test marblestone::tests::test_edge_type_all_returns_4_variants ... ok
test marblestone::tests::test_edge_type_serde_roundtrip ... ok
[... all 35 edge_type tests ...]
test result: ok. 100+ passed; 0 failed; 0 ignored
```

---

## 6. Constraints & Anti-Patterns

### 6.1 Constitution Compliance
- `AP-009`: No NaN/Infinity in weights - all default_weight() values are valid f32
- `naming.types`: PascalCase for enum (EdgeType)
- `naming.json`: snake_case for serde (semantic, temporal, etc.)

### 6.2 Anti-Patterns to Avoid
- ❌ DO NOT keep the old EdgeType in graph_edge.rs (creates duplicate definitions)
- ❌ DO NOT add backwards compatibility shims
- ❌ DO NOT add extra variants not in constitution (Associative, Contradicts, Supports are REMOVED)
- ❌ DO NOT exceed 500 lines per module (excluding tests)

---

## 7. Dependencies & Blockers

### 7.1 Prerequisites (VERIFIED COMPLETE)
- ✅ TASK-M02-007: Domain enum exists in marblestone.rs
- ✅ TASK-M02-008: NeurotransmitterWeights exists in marblestone.rs
- ✅ marblestone.rs file exists and compiles

### 7.2 Downstream Impact
After this task completes:
- TASK-M02-010 (GraphEdge struct) can proceed using this EdgeType
- TASK-M02-011 (GraphEdge methods) can proceed
- graph_edge.rs tests will use the canonical EdgeType

---

## 8. Final Verification: Sherlock-Holmes Audit (MANDATORY)

After completing all implementation, you MUST spawn a sherlock-holmes agent to verify:

1. **Code Correctness**: EdgeType has exactly 4 variants matching constitution
2. **No Duplicates**: Only one EdgeType definition exists (in marblestone.rs)
3. **All Tests Pass**: 100+ tests pass, 0 failures
4. **No Clippy Warnings**: `cargo clippy` produces 0 warnings
5. **Import Chain Valid**: graph_edge.rs successfully imports from marblestone

**Sherlock-Holmes Agent Prompt**:
```
Verify TASK-M02-009 completion:
1. Check EdgeType enum in marblestone.rs has exactly 4 variants: Semantic, Temporal, Causal, Hierarchical
2. Verify NO EdgeType enum exists in types/graph_edge.rs (must be removed)
3. Verify graph_edge.rs imports EdgeType from crate::marblestone
4. Run: cargo test --package context-graph-core edge_type -- verify all pass
5. Run: cargo clippy --package context-graph-core -- verify 0 warnings
6. Verify lib.rs exports EdgeType in the re-exports line
Report any discrepancies as BLOCKING issues.
```

---

## 9. Success Criteria Checklist

- [ ] EdgeType enum added to marblestone.rs with 4 variants
- [ ] EdgeType has description(), all(), default_weight() methods
- [ ] EdgeType has Default trait (returns Semantic)
- [ ] EdgeType has Display trait (lowercase strings)
- [ ] EdgeType has Serde with snake_case
- [ ] EdgeType has Clone, Copy, Debug, PartialEq, Eq, Hash derives
- [ ] 35+ unit tests added and passing
- [ ] lib.rs re-exports EdgeType
- [ ] graph_edge.rs local EdgeType REMOVED
- [ ] graph_edge.rs imports EdgeType from marblestone
- [ ] cargo build succeeds
- [ ] cargo test succeeds (100+ tests)
- [ ] cargo clippy shows 0 warnings
- [ ] Sherlock-Holmes verification complete

---

*Task ID: TASK-M02-009*
*Module: 02 - Core Infrastructure*
*Layer: Foundation*
*Estimated Hours: 1.5 (increased from 0.5 due to migration)*
*Last Updated: 2025-12-31*
