# TASK-M02-025: Implement StorageError Enum

```xml
<task_spec id="TASK-M02-025" version="1.0">
<metadata>
  <title>Implement StorageError Enum</title>
  <status>blocked</status>
  <layer>surface</layer>
  <module>module-02</module>
  <sequence>25</sequence>
  <priority>high</priority>
  <estimated_hours>1.5</estimated_hours>
  <implements>
    <item>TECH-CORE-002 Section 3: Storage specification</item>
    <item>REQ-CORE-005: Storage requirements</item>
  </implements>
  <depends_on>
    <task_ref>TASK-M02-013</task_ref>
  </depends_on>
  <estimated_complexity>low</estimated_complexity>
</metadata>

<context>
This task defines a comprehensive error enum for all storage operations. The enum uses thiserror for ergonomic error derivation and includes From implementations for underlying error types (rocksdb::Error, bincode::Error). Error messages are designed to be actionable and include context about what operation failed.
</context>

<input_context_files>
  <file purpose="Storage crate structure">crates/context-graph-storage/src/lib.rs</file>
  <file purpose="Constitution for error handling rules">docs2/constitution.yaml</file>
</input_context_files>

<prerequisites>
  <check>TASK-M02-013 (Storage Crate Structure) completed</check>
  <check>thiserror dependency added to Cargo.toml</check>
</prerequisites>

<scope>
  <in_scope>
    - StorageError enum with 9+ variants
    - thiserror derive for Display and Error traits
    - From implementations for rocksdb::Error and bincode::Error
    - Contextual error messages with field names and values
    - Unit tests for error formatting
  </in_scope>
  <out_of_scope>
    - MCP-specific error codes (future MCP module)
    - Error recovery strategies (handled at higher level)
  </out_of_scope>
</scope>

<definition_of_done>
  <signatures>
    <signature file="crates/context-graph-storage/src/lib.rs">
use thiserror::Error;
use uuid::Uuid;

/// Comprehensive error type for storage operations.
///
/// All variants include contextual information to aid debugging.
#[derive(Debug, Error)]
pub enum StorageError {
    /// Database failed to open
    #[error("Failed to open database at {path}: {source}")]
    OpenFailed {
        path: String,
        #[source]
        source: rocksdb::Error,
    },

    /// Column family not found
    #[error("Column family '{cf_name}' not found in database")]
    ColumnFamilyNotFound { cf_name: String },

    /// Node validation failed before storage
    #[error("Validation failed for node {node_id}: {reason}")]
    ValidationFailed {
        node_id: Option&lt;Uuid&gt;,
        reason: String,
    },

    /// Serialization error
    #[error("Failed to serialize {entity_type}: {source}")]
    SerializationFailed {
        entity_type: String,
        #[source]
        source: bincode::Error,
    },

    /// Deserialization error
    #[error("Failed to deserialize {entity_type}: {source}")]
    DeserializationFailed {
        entity_type: String,
        #[source]
        source: bincode::Error,
    },

    /// Entity not found
    #[error("{entity_type} with ID {id} not found")]
    NotFound { entity_type: String, id: String },

    /// Write operation failed
    #[error("Write failed for {entity_type}: {source}")]
    WriteFailed {
        entity_type: String,
        #[source]
        source: rocksdb::Error,
    },

    /// Read operation failed
    #[error("Read failed for {entity_type}: {source}")]
    ReadFailed {
        entity_type: String,
        #[source]
        source: rocksdb::Error,
    },

    /// Index corruption detected
    #[error("Index corruption detected in {index_name}: {details}")]
    IndexCorrupted { index_name: String, details: String },

    /// Generic internal error
    #[error("Internal storage error: {0}")]
    Internal(String),
}
    </signature>
  </signatures>

  <constraints>
    - All variants must include contextual information
    - Error messages must be human-readable and actionable
    - Must use thiserror for derivation
    - From implementations for underlying errors must preserve source
    - NotFound is NOT an error in some contexts (check before returning)
  </constraints>

  <verification>
    - cargo build --package context-graph-storage compiles without errors
    - cargo test --package context-graph-storage error passes all tests
    - Error messages include relevant context
    - From implementations work for underlying errors
  </verification>
</definition_of_done>

<pseudo_code>
lib.rs (additions):

use thiserror::Error;
use uuid::Uuid;

#[derive(Debug, Error)]
pub enum StorageError {
    // All variants with thiserror attributes
    // As shown in signatures above
}

// Convenience constructor methods
impl StorageError:
  fn not_found_node(id: NodeId) -> Self:
    StorageError::NotFound {
      entity_type: "MemoryNode".to_string(),
      id: id.to_string(),
    }

  fn not_found_edge(source: NodeId, target: NodeId, edge_type: EdgeType) -> Self:
    StorageError::NotFound {
      entity_type: "GraphEdge".to_string(),
      id: format!("{}->{}:{:?}", source, target, edge_type),
    }

  fn not_found_embedding(id: NodeId) -> Self:
    StorageError::NotFound {
      entity_type: "Embedding".to_string(),
      id: id.to_string(),
    }

// From implementations
impl From&lt;rocksdb::Error&gt; for StorageError:
  fn from(e: rocksdb::Error) -> Self:
    StorageError::Internal(e.to_string())

impl From&lt;bincode::Error&gt; for StorageError:
  fn from(e: bincode::Error) -> Self:
    StorageError::Internal(format!("Bincode error: {}", e))

// Result type alias
pub type StorageResult&lt;T&gt; = Result&lt;T, StorageError&gt;;

#[cfg(test)]
mod error_tests:
  test_error_display_open_failed()
  test_error_display_not_found()
  test_from_rocksdb_error()
  test_from_bincode_error()
  test_convenience_constructors()
</pseudo_code>

<files_to_create>
  <!-- No new files - additions to existing lib.rs -->
</files_to_create>

<files_to_modify>
  <file path="crates/context-graph-storage/src/lib.rs">Add StorageError enum and implementations</file>
  <file path="crates/context-graph-storage/Cargo.toml">Ensure thiserror dependency is present</file>
</files_to_modify>

<validation_criteria>
  <criterion>StorageError enum compiles with 9+ variants</criterion>
  <criterion>All variants include contextual information</criterion>
  <criterion>From implementations for rocksdb::Error and bincode::Error work</criterion>
  <criterion>Error messages are human-readable and include context</criterion>
  <criterion>Convenience constructors simplify common error creation</criterion>
</validation_criteria>

<test_commands>
  <command>cargo build --package context-graph-storage</command>
  <command>cargo test --package context-graph-storage error -- --nocapture</command>
  <command>cargo clippy --package context-graph-storage -- -D warnings</command>
</test_commands>
</task_spec>
```

## Implementation Notes

### Error Context Philosophy
From the constitution (rules section):
> "Result<T,E> for fallible ops, thiserror for derivation"
> "Never unwrap() in prod; use expect() with context"

Each error variant includes enough context to:
1. Identify WHAT failed (entity type, operation)
2. Identify WHERE it failed (path, CF name, ID)
3. Identify WHY it failed (source error chain)

### MCP Error Code Mapping (Future Reference)
These storage errors will map to MCP error codes in future:
- NotFound → -32000 (SessionNotFound) or custom
- ValidationFailed → -32602 (Invalid params)
- Internal → -32603 (Internal error)

---

*Task ID: TASK-M02-025*
*Module: 02 - Core Infrastructure*
*Layer: Surface*
