# TASK-M02-025: Complete StorageError Enum

## Task Metadata
- **Status:** READY
- **Layer:** surface
- **Module:** module-02
- **Priority:** high
- **Estimated Hours:** 1.5
- **Dependencies:** TASK-M02-013 (Storage Crate Structure) ‚úÖ COMPLETE

---

## Current State (As of 2025-12-31)

**StorageError EXISTS** at `crates/context-graph-storage/src/rocksdb_backend/error.rs` with 8 variants.

### Existing Variants:
```rust
pub enum StorageError {
    OpenFailed { path: String, message: String },
    ColumnFamilyNotFound { name: String },
    WriteFailed(String),
    ReadFailed(String),
    FlushFailed(String),
    NotFound { id: String },
    Serialization(String),
    ValidationFailed(String),
}
```

### Missing Per Spec:
1. `IndexCorrupted { index_name: String, details: String }` - For detecting index corruption
2. `Internal(String)` - For generic internal errors
3. Convenience constructors: `not_found_node()`, `not_found_edge()`, `not_found_embedding()`
4. `StorageResult<T>` type alias

### Existing From Impls:
- `From<SerializationError>` ‚úÖ
- `From<ValidationError>` ‚úÖ

---

## Objective

Complete the StorageError enum by adding 2 missing variants, convenience constructors, and the `StorageResult<T>` type alias. **No backwards compatibility - if existing code breaks, fix it or fail fast.**

---

## Files to Modify

| File | Action |
|------|--------|
| `crates/context-graph-storage/src/rocksdb_backend/error.rs` | Add missing variants, constructors, type alias |
| `crates/context-graph-storage/src/rocksdb_backend/mod.rs` | Export `StorageResult` if needed |
| `crates/context-graph-storage/src/lib.rs` | Re-export `StorageResult` if needed |

---

## Exact Changes Required

### 1. Add Missing Variants to StorageError

Add these to the existing enum in `error.rs`:

```rust
/// Index corruption detected during scan or validation.
#[error("Index corruption detected in {index_name}: {details}")]
IndexCorrupted {
    index_name: String,
    details: String
},

/// Generic internal error for unexpected failures.
#[error("Internal storage error: {0}")]
Internal(String),
```

### 2. Add Convenience Constructors

Add `impl StorageError` block with these methods:

```rust
use context_graph_core::types::{NodeId, EdgeId};
use context_graph_core::marblestone::EdgeType;

impl StorageError {
    /// Create NotFound for a missing MemoryNode
    pub fn not_found_node(id: NodeId) -> Self {
        StorageError::NotFound {
            id: id.to_string(),
        }
    }

    /// Create NotFound for a missing GraphEdge
    pub fn not_found_edge(source: NodeId, target: NodeId, edge_type: EdgeType) -> Self {
        StorageError::NotFound {
            id: format!("{}->{}:{:?}", source, target, edge_type),
        }
    }

    /// Create NotFound for a missing Embedding
    pub fn not_found_embedding(id: NodeId) -> Self {
        StorageError::NotFound {
            id: format!("embedding:{}", id),
        }
    }
}
```

### 3. Add StorageResult Type Alias

Add at the end of `error.rs`:

```rust
/// Convenient Result type for storage operations
pub type StorageResult<T> = Result<T, StorageError>;
```

### 4. Export StorageResult

In `rocksdb_backend/mod.rs`, add to re-exports:
```rust
pub use error::{StorageError, StorageResult};
```

In `lib.rs`, update re-export:
```rust
pub use rocksdb_backend::{
    RocksDbConfig, RocksDbMemex, StorageError, StorageResult,
    DEFAULT_CACHE_SIZE, DEFAULT_MAX_OPEN_FILES,
};
```

---

## Tests Required

Add these tests to `error.rs`:

```rust
#[test]
fn test_error_index_corrupted() {
    let error = StorageError::IndexCorrupted {
        index_name: "johari_open".to_string(),
        details: "UUID parse failed".to_string(),
    };
    let msg = error.to_string();
    assert!(msg.contains("johari_open"));
    assert!(msg.contains("UUID parse failed"));
}

#[test]
fn test_error_internal() {
    let error = StorageError::Internal("unexpected state".to_string());
    assert!(error.to_string().contains("Internal storage error"));
}

#[test]
fn test_not_found_node() {
    let id = uuid::Uuid::new_v4();
    let error = StorageError::not_found_node(id);
    assert!(error.to_string().contains(&id.to_string()));
}

#[test]
fn test_not_found_edge() {
    use context_graph_core::marblestone::EdgeType;
    let source = uuid::Uuid::new_v4();
    let target = uuid::Uuid::new_v4();
    let error = StorageError::not_found_edge(source, target, EdgeType::Semantic);
    let msg = error.to_string();
    assert!(msg.contains(&source.to_string()[..8]));
    assert!(msg.contains(&target.to_string()[..8]));
}

#[test]
fn test_not_found_embedding() {
    let id = uuid::Uuid::new_v4();
    let error = StorageError::not_found_embedding(id);
    assert!(error.to_string().contains("embedding:"));
}

#[test]
fn test_storage_result_type_alias() {
    fn returns_result() -> StorageResult<String> {
        Ok("test".to_string())
    }
    assert!(returns_result().is_ok());
}
```

---

## Constitution Compliance

| Rule | Requirement | How Addressed |
|------|-------------|---------------|
| `rules` | `Result<T,E>` for fallible ops, thiserror | Already using thiserror ‚úÖ |
| `rules` | Never unwrap() in prod | Error variants for all failure modes |
| `AP-007` | No stub data in prod | All tests use real DB instances |
| Fail Fast | No backwards compatibility hacks | If code breaks, fix at call site |

---

## Verification Commands

```bash
# 1. Build must pass
cargo build --package context-graph-storage

# 2. All tests must pass
cargo test --package context-graph-storage -- --nocapture

# 3. Clippy clean
cargo clippy --package context-graph-storage -- -D warnings

# 4. Verify variant count
grep -c "^    #\[error" crates/context-graph-storage/src/rocksdb_backend/error.rs
# Expected: 10 (8 existing + 2 new)
```

---

## Full State Verification (REQUIRED)

### Source of Truth
The `StorageError` enum in `crates/context-graph-storage/src/rocksdb_backend/error.rs`

### Execute & Inspect Steps
After implementation, run:

```bash
# 1. Compile and run tests
cargo test --package context-graph-storage error -- --nocapture

# 2. Verify all 10 variants exist
grep "#\[error(" crates/context-graph-storage/src/rocksdb_backend/error.rs

# 3. Verify From impls work
cargo test --package context-graph-storage test_from -- --nocapture

# 4. Verify type alias is exported
grep "StorageResult" crates/context-graph-storage/src/lib.rs
```

### Boundary & Edge Case Audit (3 Cases)

**Case 1: Empty string in IndexCorrupted**
```rust
#[test]
fn edge_case_index_corrupted_empty_details() {
    println!("=== EDGE CASE 1: Empty details string ===");
    let error = StorageError::IndexCorrupted {
        index_name: "".to_string(),
        details: "".to_string(),
    };
    println!("BEFORE: Creating error with empty strings");
    let msg = error.to_string();
    println!("AFTER: message = '{}'", msg);
    assert!(msg.contains("Index corruption"));
    println!("RESULT: PASS - Handles empty strings");
}
```

**Case 2: Unicode in error messages**
```rust
#[test]
fn edge_case_unicode_in_internal_error() {
    println!("=== EDGE CASE 2: Unicode in Internal error ===");
    let error = StorageError::Internal("ÈîôËØØ: Êó•Êú¨Ë™û üî•".to_string());
    println!("BEFORE: Creating error with unicode");
    let msg = error.to_string();
    println!("AFTER: message = '{}'", msg);
    assert!(msg.contains("ÈîôËØØ"));
    assert!(msg.contains("üî•"));
    println!("RESULT: PASS - Unicode preserved");
}
```

**Case 3: Convenience constructors with nil UUID**
```rust
#[test]
fn edge_case_nil_uuid_in_not_found() {
    println!("=== EDGE CASE 3: Nil UUID in not_found_node ===");
    let nil = uuid::Uuid::nil();
    println!("BEFORE: Creating not_found_node with nil UUID");
    let error = StorageError::not_found_node(nil);
    println!("AFTER: error = '{}'", error);
    assert!(error.to_string().contains("00000000-0000-0000-0000-000000000000"));
    println!("RESULT: PASS - Nil UUID formatted correctly");
}
```

### Evidence of Success
The final test output must show:
```
test rocksdb_backend::error::tests::test_error_index_corrupted ... ok
test rocksdb_backend::error::tests::test_error_internal ... ok
test rocksdb_backend::error::tests::test_not_found_node ... ok
test rocksdb_backend::error::tests::test_not_found_edge ... ok
test rocksdb_backend::error::tests::test_not_found_embedding ... ok
test rocksdb_backend::error::tests::test_storage_result_type_alias ... ok
test rocksdb_backend::error::tests::edge_case_index_corrupted_empty_details ... ok
test rocksdb_backend::error::tests::edge_case_unicode_in_internal_error ... ok
test rocksdb_backend::error::tests::edge_case_nil_uuid_in_not_found ... ok
```

---

## Physical Verification Checklist

After completing the implementation, manually verify:

1. **Variant Count**: Run `grep -c "#\[error(" crates/context-graph-storage/src/rocksdb_backend/error.rs` ‚Üí Must be 10
2. **Export Check**: Run `grep "StorageResult" crates/context-graph-storage/src/lib.rs` ‚Üí Must find it
3. **Test Count**: Run `cargo test --package context-graph-storage error -- --list 2>/dev/null | grep -c "test$"` ‚Üí Must be 21+ (12 existing + 9 new)
4. **Build Check**: `cargo build --package context-graph-storage` ‚Üí Must succeed with 0 warnings

---

## Final Sherlock-Holmes Verification (REQUIRED)

After completing all implementation, spawn a `sherlock-holmes` agent to:
1. Verify all 10 variants exist and compile
2. Run all tests and confirm passage
3. Check that `StorageResult<T>` is properly exported
4. Verify convenience constructors are usable
5. Confirm no clippy warnings
6. Validate edge cases work correctly
7. Report any discrepancies found

**The task is NOT complete until sherlock-holmes verification passes.**

---

## What NOT To Do

- ‚ùå Do NOT add backwards compatibility shims
- ‚ùå Do NOT create separate error types for "legacy" compatibility
- ‚ùå Do NOT use mock data in tests
- ‚ùå Do NOT suppress warnings with `#[allow(...)]`
- ‚ùå Do NOT add comments like `// removed` or `// deprecated`
- ‚ùå Do NOT create new files - all changes go in existing files

---

*Task ID: TASK-M02-025*
*Module: 02 - Core Infrastructure*
*Layer: Surface*
*Last Updated: 2025-12-31*
