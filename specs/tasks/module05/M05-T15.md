# M05-T15: Implement EmotionalStateTracker with Decay

```yaml
metadata:
  id: "M05-T15"
  title: "Implement EmotionalStateTracker with Decay"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "logic"
  priority: "high"
  estimated_hours: 1
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "COMPLETE"
  dependencies:
    - "M05-T04"  # EmotionalConfig
  spec_refs:
    - "constitution.yaml lines 148-167"
    - "learntheory.md UTL formula"
```

---

## CRITICAL: Current Implementation State

**STATUS: FULLY IMPLEMENTED AND TESTED**

The emotional weight system is fully implemented across TWO components:

### 1. EmotionalState Enum (in context-graph-core)
**File**: `crates/context-graph-core/src/types/utl.rs:103-119`

This is a **discrete emotional state enum**, NOT a valence/arousal struct:

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Default, Serialize, Deserialize)]
pub enum EmotionalState {
    #[default]
    Neutral,   // weight: 1.0
    Curious,   // weight: 1.2
    Focused,   // weight: 1.3
    Stressed,  // weight: 0.8
    Fatigued,  // weight: 0.6
    Engaged,   // weight: 1.15
    Confused,  // weight: 0.9
}
```

### 2. EmotionalStateTracker (in context-graph-utl)
**File**: `crates/context-graph-utl/src/emotional/state.rs`

This provides temporal decay tracking for the discrete states:

```rust
pub struct EmotionalStateTracker {
    current_state: EmotionalState,
    intensity: f32,        // 1.0 = full, 0.0 = decayed to neutral
    decay_config: StateDecay,
    last_update: Option<Instant>,
    transition_alpha: f32, // Transition smoothing
}
```

---

## Source of Truth

| Component | File Path | Line Numbers |
|-----------|-----------|--------------|
| EmotionalState enum | `crates/context-graph-core/src/types/utl.rs` | 103-145 |
| EmotionalStateTracker | `crates/context-graph-utl/src/emotional/state.rs` | 33-267 |
| StateDecay config | `crates/context-graph-utl/src/emotional/state.rs` | 293-365 |
| EmotionalWeightCalculator | `crates/context-graph-utl/src/emotional/calculator.rs` | 48-309 |
| EmotionalConfig | `crates/context-graph-utl/src/config.rs` | 334-423 |

---

## UTL Formula Context

From constitution.yaml (lines 148-167):
```
L = f((ΔS × ΔC) · wₑ · cos φ)

wₑ: [0.5, 1.5] emotional weight
```

The emotional weight (wₑ) is computed by `EmotionalWeightCalculator`:
1. Text sentiment analysis via `SentimentLexicon`
2. State weight modifier from `EmotionalState::weight_modifier()`
3. Optional arousal/valence modulation
4. Clamped to [0.5, 1.5]

---

## Verification Commands

### Run All Emotional Tests
```bash
cargo test -p context-graph-utl --lib -- emotional 2>&1 | grep -E "(test.*ok|passed|failed)"
```

**Expected**: 54 tests pass (27 state tests, 27 calculator/lexicon tests)

### Verify EmotionalState in Core
```bash
grep -n "pub enum EmotionalState" crates/context-graph-core/src/types/utl.rs
```

**Expected**: Line 103

### Verify Re-export in UTL Crate
```bash
grep -n "pub use context_graph_core::types::EmotionalState" crates/context-graph-utl/src/emotional/mod.rs
```

**Expected**: Line 49

---

## Implementation Details

### StateDecay Configuration

```rust
pub struct StateDecay {
    pub half_life_secs: f32,       // Default: 120.0 (2 min)
    pub neutral_threshold: f32,    // Default: 0.1
    pub initial_intensity: f32,    // Default: 0.8
    pub reinforcement_boost: f32,  // Default: 0.2
}
```

Presets:
- `StateDecay::fast()`: 30s half-life (transient responses)
- `StateDecay::slow()`: 300s half-life (sustained engagement)
- `StateDecay::persistent()`: No decay (explicit changes only)

### EmotionalStateTracker Key Methods

| Method | Purpose |
|--------|---------|
| `new(state, decay)` | Create with initial state |
| `neutral()` | Create in neutral state |
| `current_state()` | Get current EmotionalState |
| `intensity()` | Get intensity [0.0, 1.0] |
| `effective_weight()` | Get weight considering decay |
| `decay(elapsed)` | Apply time-based decay |
| `update()` | Auto-track time and decay |
| `transition(state)` | Change to new state |
| `reinforce()` | Boost current state |
| `reset()` | Reset to neutral |

### Decay Algorithm

Exponential decay: `I(t) = I(0) × 0.5^(t/half_life)`

When `intensity < neutral_threshold`, auto-transition to `Neutral` state.

---

## Test Verification Results

```
test emotional::state::tests::test_tracker_creation ... ok
test emotional::state::tests::test_neutral_tracker ... ok
test emotional::state::tests::test_decay_reduces_intensity ... ok
test emotional::state::tests::test_neutral_does_not_decay ... ok
test emotional::state::tests::test_decay_to_neutral ... ok
test emotional::state::tests::test_transition ... ok
test emotional::state::tests::test_reinforce ... ok
test emotional::state::tests::test_reinforce_same_state ... ok
test emotional::state::tests::test_effective_weight ... ok
test emotional::state::tests::test_reset ... ok
test emotional::state::tests::test_force_state ... ok
test emotional::state::tests::test_is_intense ... ok
test emotional::state::tests::test_state_decay_presets ... ok
test emotional::state::tests::test_decay_factor ... ok
test emotional::state::tests::test_transition_smoothing ... ok
test emotional::state::tests::test_all_states_have_valid_weights ... ok
test emotional::state::tests::test_set_transition_alpha ... ok
```

---

## Acceptance Criteria (ALL MET)

- [x] EmotionalState enum with 7 variants (Neutral, Curious, Focused, Stressed, Fatigued, Engaged, Confused)
- [x] Each state has weight_modifier() returning [0.6, 1.3]
- [x] EmotionalStateTracker with intensity tracking
- [x] Exponential decay toward neutral state
- [x] StateDecay configuration with half-life
- [x] Transition smoothing between states
- [x] Reinforcement for repeated exposure
- [x] Re-exported from context-graph-utl crate
- [x] 54 tests passing
- [x] Integration with EmotionalWeightCalculator

---

## Dependencies

| Dependency | Purpose | Status |
|------------|---------|--------|
| M05-T04 | EmotionalConfig | ✅ COMPLETE |
| chrono | NOT USED (uses std::time::Instant) | N/A |
| serde | Serialization | ✅ Available |

---

## Related Tasks

| Task ID | Relationship | Status |
|---------|--------------|--------|
| M05-T04 | EmotionalConfig provider | ✅ COMPLETE |
| M05-T16 | EmotionalWeightCalculator consumer | ✅ COMPLETE |
| M05-T22 | UtlProcessor integration | Partial |
| M05-T31 | SentimentLexicon for text analysis | ✅ COMPLETE |

---

## Full State Verification Protocol

### 1. Verify Source of Truth
```bash
# Check EmotionalState exists in core
grep -c "weight_modifier" crates/context-graph-core/src/types/utl.rs
# Expected: 2 (definition + impl)

# Check tracker exists in utl
grep -c "pub struct EmotionalStateTracker" crates/context-graph-utl/src/emotional/state.rs
# Expected: 1
```

### 2. Execute & Inspect
```bash
cargo test -p context-graph-utl --lib -- emotional::state::tests::test_decay_to_neutral --exact 2>&1
```

### 3. Edge Case Tests (Already Implemented)

| Edge Case | Test | Result |
|-----------|------|--------|
| Empty decay | `test_neutral_does_not_decay` | Neutral stays at intensity 1.0 |
| Max decay | `test_decay_to_neutral` | Transitions to Neutral |
| Invalid intensity | `test_force_state` | Clamped to [0.0, 1.0] |

### 4. Evidence of Success
```bash
cargo test -p context-graph-utl --lib -- emotional 2>&1 | tail -3
# Expected output:
# test result: ok. 54 passed; 0 failed; 0 ignored; 0 measured; X filtered out
```

---

## SHERLOCK VERIFICATION CHECKLIST

After completion, spawn sherlock-holmes agent to verify:

1. [ ] All 54 emotional tests pass
2. [ ] EmotionalState re-exported correctly from UTL crate
3. [ ] StateDecay::decay_factor() produces mathematically correct values
4. [ ] No NaN/Infinity in any emotional weight computation
5. [ ] Weight modifiers in valid constitution range [0.6, 1.3]
6. [ ] Effective weight always in [0.5, 1.5] after calculator

---

## Architecture Note

**WHY ENUM, NOT VALENCE/AROUSAL STRUCT?**

The original task specification described a valence/arousal continuous model. The actual implementation uses discrete emotional states because:

1. **Simpler Integration**: Discrete states map directly to weight modifiers
2. **Deterministic**: Same state = same modifier (no floating-point variance)
3. **Constitution Compliance**: wₑ range is [0.5, 1.5], achieved via clamping
4. **Testability**: Finite states allow exhaustive testing

The `EmotionalStateTracker` adds temporal dynamics (decay, intensity) on top of the discrete states, achieving the desired behavior without continuous valence/arousal tracking.

---

*Task Status: COMPLETE*
*Last Verified: 2026-01-04*
*Test Count: 54 passing*
*Implementation: Production-ready*
