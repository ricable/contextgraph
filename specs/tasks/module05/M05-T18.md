# M05-T18: Implement JohariClassifier with Retrieval Strategies

```yaml
metadata:
  id: "M05-T18"
  title: "Implement JohariClassifier with Retrieval Strategies"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "surface"
  priority: "critical"
  estimated_hours: 2.5
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "COMPLETE"
  dependencies:
    - "M05-T08"  # JohariQuadrant enum in context-graph-core
    - "M05-T33"  # JohariConfig struct
  spec_refs:
    - "constitution.yaml lines 159-163"
    - "learntheory.md Johari Window section"
```

---

## CRITICAL: Task Status

**THIS TASK IS COMPLETE.** The implementation exists and passes 38 tests.

### Verification Commands (Run These First)

```bash
# Verify tests pass (38 johari tests)
cargo test -p context-graph-utl --lib johari 2>&1 | tail -5

# Expected output:
# test result: ok. 38 passed; 0 failed; 0 ignored;

# Verify files exist
ls -la crates/context-graph-utl/src/johari/
# Expected: classifier.rs (544 lines), retrieval.rs (698 lines), mod.rs (42 lines)
```

---

## Description

The JohariClassifier classifies knowledge states into Johari Window quadrants based on surprise (delta_s) and coherence (delta_c) values per the UTL constitution.

**Johari Quadrant Mapping (from constitution.yaml:159-163):**

| Quadrant | ΔS (Surprise) | ΔC (Coherence) | Action |
|----------|---------------|----------------|--------|
| **Open** | < threshold | > threshold | DirectRecall |
| **Blind** | >= threshold | < threshold | EpistemicAction |
| **Hidden** | < threshold | < threshold | GetNeighborhood |
| **Unknown** | >= threshold | >= threshold | TriggerDream |

Default thresholds: 0.5 for both surprise and coherence.

---

## Actual Implementation (What Exists Now)

### File Structure

```
crates/context-graph-utl/src/johari/
├── mod.rs          # 42 lines - module re-exports
├── classifier.rs   # 544 lines - JohariClassifier struct + classify_quadrant()
└── retrieval.rs    # 698 lines - SuggestedAction enum + QuadrantRetrieval struct
```

### Key Types Implemented

**1. JohariClassifier** (`classifier.rs:112-368`)
- `new(config: &JohariConfig)` - Create from config
- `with_default_thresholds()` - Create with 0.5/0.5 thresholds
- `with_thresholds(s: f32, c: f32)` - Create with custom thresholds
- `classify(delta_s: f32, delta_c: f32) -> JohariQuadrant` - Core classification
- `classify_with_confidence(delta_s, delta_c) -> (JohariQuadrant, f32)` - With confidence score
- `is_near_boundary(delta_s, delta_c) -> bool` - Boundary detection
- Threshold getters: `surprise_threshold()`, `coherence_threshold()`, `boundary_width()`

**2. SuggestedAction** (`retrieval.rs:41-129`)
```rust
pub enum SuggestedAction {
    DirectRecall,      // Open quadrant
    EpistemicAction,   // Blind quadrant
    GetNeighborhood,   // Hidden quadrant
    TriggerDream,      // Unknown quadrant
}
```
Methods: `description()`, `urgency()`, `all()`

**3. QuadrantRetrieval** (`retrieval.rs:215-480`)
- `new(config: &JohariConfig)` - Create from config
- `with_default_weights()` - Use default weights (Open=1.0, Blind=0.7, Hidden=0.3, Unknown=0.5)
- `get_weight(quadrant) -> f32` - Get retrieval weight
- `get_action(quadrant) -> SuggestedAction` - Get suggested action
- `apply_weight(quadrant, base_score) -> f32` - Apply weight to score
- `should_include_by_default(quadrant) -> bool` - Check default inclusion

**4. Standalone Functions**
- `classify_quadrant(delta_s, delta_c) -> JohariQuadrant` - Convenience function
- `get_suggested_action(quadrant) -> SuggestedAction` - Action mapping
- `get_retrieval_weight(quadrant) -> f32` - Weight lookup

### Dependencies (Already Exist)

| Dependency | Location | Status |
|------------|----------|--------|
| `JohariQuadrant` | `context-graph-core/src/types/johari/quadrant.rs:23` | EXISTS |
| `JohariConfig` | `context-graph-utl/src/config.rs:554` | EXISTS |
| Re-export | `context-graph-utl/src/johari/mod.rs:42` | EXISTS |

---

## JohariConfig Reference (config.rs:554-594)

```rust
pub struct JohariConfig {
    pub surprise_threshold: f32,    // Default: 0.5
    pub coherence_threshold: f32,   // Default: 0.5
    pub fuzzy_boundaries: bool,     // Default: true
    pub boundary_width: f32,        // Default: 0.1, Range: [0.0, 0.2]
    pub open_weight: f32,           // Default: 1.0
    pub blind_weight: f32,          // Default: 1.2
    pub hidden_weight: f32,         // Default: 0.8
    pub unknown_weight: f32,        // Default: 1.5
}
```

---

## Classification Logic (classifier.rs:70-85)

```rust
fn classify_with_thresholds(delta_s: f32, delta_c: f32, s_thresh: f32, c_thresh: f32) -> JohariQuadrant {
    let low_surprise = delta_s < s_thresh;
    let high_coherence = delta_c > c_thresh;  // NOTE: > not >=

    match (low_surprise, high_coherence) {
        (true, true) => JohariQuadrant::Open,    // Low S, High C
        (false, false) => JohariQuadrant::Blind, // High S, Low C
        (true, false) => JohariQuadrant::Hidden, // Low S, Low C
        (false, true) => JohariQuadrant::Unknown,// High S, High C
    }
}
```

**CRITICAL BOUNDARY BEHAVIOR:**
- `delta_s == 0.5` with default threshold → NOT low_surprise (>= becomes high)
- `delta_c == 0.5` with default threshold → NOT high_coherence (<= becomes low)
- Therefore `classify_quadrant(0.5, 0.5)` → `JohariQuadrant::Blind`

---

## Test Coverage (38 Tests Passing)

```bash
cargo test -p context-graph-utl --lib johari 2>&1 | grep "test johari"
```

**Classifier Tests (20):**
- `test_classify_quadrant_open/blind/hidden/unknown` - Core quadrant classification
- `test_classify_quadrant_boundary` - Exact 0.5 threshold behavior
- `test_classifier_new/default/with_custom_thresholds` - Constructor variants
- `test_classifier_clamps_input` - Input clamping to [0,1]
- `test_classify_with_confidence_high/low/no_fuzzy` - Confidence scoring
- `test_is_near_boundary` - Boundary proximity detection
- `test_constitution_compliance` - Per-spec verification
- `test_extreme_values` - Corner cases (0,0), (1,1), etc.

**Retrieval Tests (18):**
- `test_suggested_action_mapping` - Quadrant→Action mapping
- `test_retrieval_weight` - Weight lookup
- `test_quadrant_retrieval_*` - QuadrantRetrieval struct tests
- `test_constitution_compliance` - Action mapping per spec

---

## NO BACKWARDS COMPATIBILITY

The implementation uses strict threshold comparisons:
- `delta_s < threshold` for "low surprise" (NOT `<=`)
- `delta_c > threshold` for "high coherence" (NOT `>=`)

This means exact threshold values fall into specific quadrants:
- `(0.5, 0.5)` → Blind (high surprise, low coherence)

**Do NOT change this behavior.** Tests explicitly verify this boundary logic.

---

## Full State Verification Requirements

### Source of Truth
- **Classification result**: Return value of `classifier.classify(delta_s, delta_c)`
- **Action mapping**: Return value of `get_suggested_action(quadrant)`
- **Weight application**: Return value of `retrieval.apply_weight(quadrant, base_score)`

### Execute & Inspect Protocol

After any modification, run:
```bash
# 1. Run all johari tests
cargo test -p context-graph-utl --lib johari 2>&1

# 2. Verify specific boundary cases
cargo test -p context-graph-utl --lib test_classify_quadrant_boundary -- --nocapture

# 3. Verify constitution compliance
cargo test -p context-graph-utl --lib test_constitution_compliance -- --nocapture
```

### Boundary & Edge Case Audit (3 Cases)

**Case 1: Exact Threshold Values**
```rust
// Before: delta_s=0.5, delta_c=0.5
// Expected: Blind (high S, low C due to >= and <= exclusivity)
let quadrant = classify_quadrant(0.5, 0.5);
assert_eq!(quadrant, JohariQuadrant::Blind);
println!("BEFORE: (0.5, 0.5) -> {:?}", quadrant);
```

**Case 2: Near-Zero Values**
```rust
// Before: delta_s=0.0, delta_c=0.0
// Expected: Hidden (low S, low C)
let quadrant = classify_quadrant(0.0, 0.0);
assert_eq!(quadrant, JohariQuadrant::Hidden);
println!("BEFORE: (0.0, 0.0) -> {:?}", quadrant);
```

**Case 3: Maximum Values**
```rust
// Before: delta_s=1.0, delta_c=1.0
// Expected: Unknown (high S, high C)
let quadrant = classify_quadrant(1.0, 1.0);
assert_eq!(quadrant, JohariQuadrant::Unknown);
println!("BEFORE: (1.0, 1.0) -> {:?}", quadrant);
```

### Evidence of Success
After running tests, output shows:
```
test result: ok. 38 passed; 0 failed; 0 ignored;
```

---

## Usage Examples (Copy-Paste Ready)

### Basic Classification
```rust
use context_graph_utl::johari::{classify_quadrant, JohariQuadrant};

let q = classify_quadrant(0.3, 0.7);  // Low surprise, high coherence
assert_eq!(q, JohariQuadrant::Open);
```

### With JohariClassifier
```rust
use context_graph_utl::johari::JohariClassifier;
use context_graph_utl::config::JohariConfig;

let config = JohariConfig::default();
let classifier = JohariClassifier::new(&config);

let q = classifier.classify(0.8, 0.2);  // High surprise, low coherence
assert_eq!(q, JohariQuadrant::Blind);

let (q, confidence) = classifier.classify_with_confidence(0.3, 0.7);
assert_eq!(q, JohariQuadrant::Open);
assert!(confidence > 0.5);
```

### With QuadrantRetrieval
```rust
use context_graph_utl::johari::{QuadrantRetrieval, JohariQuadrant, SuggestedAction};
use context_graph_utl::config::JohariConfig;

let config = JohariConfig::default();
let retrieval = QuadrantRetrieval::new(&config);

let weight = retrieval.get_weight(JohariQuadrant::Open);  // 1.0
let action = retrieval.get_action(JohariQuadrant::Blind); // EpistemicAction
let weighted_score = retrieval.apply_weight(JohariQuadrant::Hidden, 0.8);  // 0.8 * 0.3 = 0.24
```

---

## Acceptance Criteria (All Met)

- [x] JohariClassifier struct with configurable thresholds from JohariConfig
- [x] `classify()` returns correct quadrant based on threshold comparisons
- [x] `classify_with_confidence()` returns quadrant + confidence score
- [x] `is_near_boundary()` detects values near threshold boundaries
- [x] SuggestedAction enum with DirectRecall, EpistemicAction, GetNeighborhood, TriggerDream
- [x] `get_suggested_action()` maps quadrants to actions per constitution
- [x] QuadrantRetrieval struct with configurable weights
- [x] Retrieval weights: Open=1.0, Blind=0.7, Hidden=0.3, Unknown=0.5 (defaults)
- [x] Input clamping to [0.0, 1.0] range
- [x] 38 tests passing including boundary cases and constitution compliance

---

## Related Tasks

| Task ID | Relationship | Status |
|---------|--------------|--------|
| M05-T08 | Provides JohariQuadrant enum | COMPLETE |
| M05-T33 | Provides JohariConfig struct | COMPLETE |
| M05-T22 | Will integrate classifier into UtlProcessor | PARTIAL |
| M05-T37 | Maps quadrant to MCP verbosity tier | PENDING |
| M05-T38 | Uses retrieval strategy in inject_context | PENDING |

---

## Final Verification (Sherlock Protocol)

**MANDATORY:** Before marking this task complete in any review, execute:

```bash
# 1. Full test suite
cargo test -p context-graph-utl --lib 2>&1 | tail -5

# 2. Johari-specific tests with details
cargo test -p context-graph-utl --lib johari -- --nocapture 2>&1 | head -50

# 3. Verify file structure
find crates/context-graph-utl/src/johari -name "*.rs" -exec wc -l {} \;

# 4. Verify no compilation errors
cargo check -p context-graph-utl 2>&1 | tail -3
```

**Expected Results:**
- 369 total tests pass (38 johari tests)
- classifier.rs ~544 lines, retrieval.rs ~698 lines, mod.rs ~42 lines
- No compilation errors

**If any verification fails:** Do NOT mark complete. Debug and fix the actual issue - no workarounds.

---

*Task verified: 2026-01-04*
*Implementation: COMPLETE*
*Tests: 38 passing*
*Lines of code: 1284 total*
