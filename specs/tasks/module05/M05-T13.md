# M05-T13: CoherenceTracker Implementation

| Field | Value |
|-------|-------|
| **Task ID** | M05-T13 |
| **Module** | context-graph-utl |
| **Status** | **COMPLETE** ✅ |
| **Priority** | P0 (Critical Path) |
| **Depends On** | M05-T12 (RollingWindow), M05-T03 (CoherenceConfig) |
| **Verified** | 2026-01-04 via cargo test |
| **Constitution Refs** | TECH-UTL-005 Section 6, utl.lifecycle (constitution.yaml:164-167) |

---

## ⚠️ CRITICAL: TASK STATUS

**This task is COMPLETE.** The CoherenceTracker is fully implemented and tested.

**Verification Command:**
```bash
cargo test -p context-graph-utl --lib -- coherence 2>&1 | grep -E "(test|passed|failed)"
# Expected: All coherence tests pass (23+ tests)
```

**Implementation Location:** `crates/context-graph-utl/src/coherence/tracker.rs` (629 lines)

---

## Executive Summary

The `CoherenceTracker` maintains a rolling window of recent embeddings and computes coherence scores based on semantic similarity and temporal consistency. This measures the ΔC (delta_c) component of the UTL formula.

**Formula:**
```text
coherence = (similarity_weight * avg_similarity) + (consistency_weight * consistency_score)
```

Where:
- `avg_similarity` = average cosine similarity with k nearest neighbors (mapped from [-1,1] to [0,1])
- `consistency_score` = exp(-k * avg_variance) measuring embedding stability over time
- EMA smoothing applied for temporal stability

---

## Actual Implementation (Verified)

### File Location

**Source:** `crates/context-graph-utl/src/coherence/tracker.rs`

### Struct Definition (ACTUAL)

```rust
#[derive(Debug, Clone)]
pub struct CoherenceTracker {
    /// Rolling window of recent embeddings
    window: RollingWindow<Vec<f32>>,
    /// Weight for semantic similarity contribution [0.0, 1.0]
    similarity_weight: f32,
    /// Weight for consistency contribution [0.0, 1.0]
    consistency_weight: f32,
    /// Minimum coherence threshold [0.0, 0.5]
    min_threshold: f32,
    /// EMA smoothed coherence value
    ema_coherence: Option<f32>,
    /// EMA smoothing factor (alpha)
    ema_alpha: f32,
    /// Whether to use EMA smoothing
    use_ema: bool,
    /// Number of neighbors to consider
    neighbor_count: usize,
}
```

### API (ACTUAL - DO NOT CHANGE)

```rust
impl CoherenceTracker {
    /// Create tracker from config reference
    pub fn new(config: &CoherenceConfig) -> Self;

    /// Create with custom EMA settings
    pub fn with_ema(config: &CoherenceConfig, ema_alpha: f32) -> Self;

    /// Create without EMA smoothing
    pub fn without_ema(config: &CoherenceConfig) -> Self;

    /// Compute coherence for current embedding against history
    /// NOTE: Takes explicit history vector, NOT content string
    pub fn compute_coherence(&self, current: &[f32], history: &[Vec<f32>]) -> f32;

    /// Update window with new embedding
    pub fn update(&mut self, embedding: &[f32]);

    /// Update and compute in one call (applies EMA)
    pub fn update_and_compute(&mut self, embedding: &[f32]) -> f32;

    /// Get EMA-smoothed coherence
    pub fn smoothed_coherence(&self) -> Option<f32>;

    /// Get history length
    pub fn history_len(&self) -> usize;

    /// Check if sufficient history (>=2)
    pub fn has_sufficient_history(&self) -> bool;

    /// Clear all history
    pub fn clear(&mut self);
}
```

### Dependencies (ACTUAL)

```rust
use crate::config::CoherenceConfig;
use crate::error::{UtlError, UtlResult};
use super::window::RollingWindow;
// cosine_similarity is defined locally in this file, NOT imported
```

---

## Configuration (from CoherenceConfig)

Located in `crates/context-graph-utl/src/config.rs:229-274`:

```rust
pub struct CoherenceConfig {
    pub similarity_weight: f32,        // Default: 0.5, Range: [0.0, 1.0]
    pub consistency_weight: f32,       // Default: 0.7, Range: [0.0, 1.0]
    pub min_threshold: f32,            // Default: 0.1, Range: [0.0, 0.5]
    pub decay_rate: f32,               // Default: 0.05, Range: [0.0, 1.0]
    pub neighbor_count: usize,         // Default: 10
    pub neighbor_similarity_min: f32,  // Default: 0.3, Range: [0.0, 1.0]
    pub use_graph_coherence: bool,     // Default: true
    pub graph_weight: f32,             // Default: 0.4, Range: [0.0, 1.0]
}
```

---

## Existing Tests (23 tests in tracker.rs)

| Test | Purpose | Lines |
|------|---------|-------|
| test_tracker_new | Constructor with config | 381-388 |
| test_tracker_with_ema | Custom EMA constructor | 390-395 |
| test_tracker_without_ema | Disabled EMA constructor | 397-402 |
| test_compute_coherence_empty_history | Returns min_threshold | 404-411 |
| test_compute_coherence_single_history | High coherence for identical | 413-427 |
| test_compute_coherence_similar_history | Similar vectors = high coherence | 429-447 |
| test_compute_coherence_dissimilar_history | Dissimilar = lower coherence | 449-462 |
| test_update | Window update | 464-474 |
| test_update_and_compute | Combined operation | 476-492 |
| test_has_sufficient_history | >=2 check | 494-504 |
| test_clear | Clear and reset | 506-519 |
| test_cosine_similarity_* | 6 tests for cosine_similarity | 521-564 |
| test_validate_inputs_* | 4 validation tests | 566-605 |
| test_ema_smoothing | EMA behavior | 607-627 |

---

## ⚠️ WHAT NOT TO DO

1. **DO NOT redefine CoherenceEntry** - it does not exist, use `Vec<f32>` embeddings
2. **DO NOT import cosine_similarity** - it's defined locally in tracker.rs:316-330
3. **DO NOT change API signatures** - the existing API is stable and tested
4. **DO NOT add KnowledgeGraphRef trait** - structural coherence is handled in `structural.rs` separately
5. **DO NOT duplicate window logic** - use `RollingWindow<Vec<f32>>` from window.rs

---

## Integration with Upstream Dependencies

### M05-T03: CoherenceConfig
- **File:** `crates/context-graph-utl/src/config.rs:229-274`
- **Status:** ✅ Complete
- **Provides:** Configuration for weights, thresholds, neighbor count

### M05-T12: RollingWindow
- **File:** `crates/context-graph-utl/src/coherence/window.rs`
- **Status:** ✅ Complete
- **Provides:** `RollingWindow<T>`, `WindowConfig`, variance computation

---

## Downstream Consumers

### M05-T14: Structural Coherence
- **File:** `crates/context-graph-utl/src/coherence/structural.rs`
- **Status:** ✅ Complete
- **Uses:** Separate struct, does NOT extend CoherenceTracker

### M05-T22: UtlProcessor
- **Status:** Partial
- **Will Use:** CoherenceTracker for ΔC computation

---

## Full State Verification Requirements

### Source of Truth
- **Primary:** `crates/context-graph-utl/src/coherence/tracker.rs`
- **Config:** `crates/context-graph-utl/src/config.rs`
- **Tests:** Inline in tracker.rs (23 tests)

### Execute & Inspect Protocol

After ANY changes, run:
```bash
# 1. Run all coherence tests
cargo test -p context-graph-utl --lib -- coherence 2>&1 | tee /tmp/coherence_test.log

# 2. Verify test count matches (should be 23+ tests)
grep -E "^test.*ok$" /tmp/coherence_test.log | wc -l

# 3. Verify no failures
grep -E "(FAILED|panicked)" /tmp/coherence_test.log && echo "FAILURES DETECTED" || echo "ALL PASS"

# 4. Check for any warnings
cargo clippy -p context-graph-utl 2>&1 | grep -E "^warning" | head -20
```

### Boundary & Edge Case Audit

**Edge Case 1: Empty History**
```rust
let tracker = CoherenceTracker::new(&config);
let coherence = tracker.compute_coherence(&[0.1, 0.2], &[]);
assert_eq!(coherence, config.min_threshold); // Returns min_threshold (0.1)
```
**Before:** Empty history, coherence=undefined
**After:** Returns min_threshold (0.1), not 0.0 or panic

**Edge Case 2: Identical Vectors**
```rust
let mut tracker = CoherenceTracker::new(&config);
let emb = vec![0.5, 0.5, 0.5, 0.5];
let coherence = tracker.compute_coherence(&emb, &[emb.clone()]);
// Expected: coherence > 0.7 (high similarity mapped to [0,1])
```
**Before:** cosine_similarity=1.0
**After:** coherence=(1.0+1.0)/2=1.0 → 1.0 (maps [-1,1] to [0,1])

**Edge Case 3: Orthogonal Vectors**
```rust
let a = vec![1.0, 0.0, 0.0, 0.0];
let b = vec![0.0, 1.0, 0.0, 0.0];
let coherence = tracker.compute_coherence(&a, &[b]);
// Expected: coherence ≈ 0.5 (orthogonal maps to neutral)
```
**Before:** cosine_similarity=0.0
**After:** coherence=(0.0+1.0)/2=0.5

### Evidence of Success

Final verification log format:
```
=== CoherenceTracker State Verification ===
Timestamp: [ISO8601]
Test Count: 23 passed, 0 failed
Window Capacity: 10 (from config.neighbor_count)
Similarity Weight: 0.5
Consistency Weight: 0.7
Min Threshold: 0.1
EMA Alpha: 0.3
Use EMA: true
===========================================
```

---

## Sherlock-Holmes Final Verification

**Mandatory:** After completing any work on this task, spawn a `sherlock-holmes` subagent with the following prompt:

```
FORENSIC AUDIT: M05-T13 CoherenceTracker

Investigate:
1. Does tracker.rs compile without errors?
2. Do all 23 tests pass?
3. Is cosine_similarity defined locally (not imported)?
4. Does compute_coherence return values in [0, 1]?
5. Does the EMA smoothing work correctly?
6. Are there any unwrap() calls in production code?

Commands to run:
cargo test -p context-graph-utl --lib -- coherence
cargo clippy -p context-graph-utl -- -D warnings

Report any discrepancies between this task document and actual codebase.
```

---

## Revision History

| Date | Author | Changes |
|------|--------|---------|
| 2026-01-04 | AI Agent | Initial task creation |
| 2026-01-04 | AI Agent | **MAJOR REVISION**: Corrected to match actual implementation. Task was claiming "Pending" but code is complete. Fixed API signatures, removed non-existent types (CoherenceEntry, KnowledgeGraphRef), documented actual implementation. |

---

## Quick Reference Card

```
CoherenceTracker Cheat Sheet
============================
Location: crates/context-graph-utl/src/coherence/tracker.rs
Lines: 629
Tests: 23 passing

Key Types:
- CoherenceTracker (this file)
- RollingWindow<Vec<f32>> (from window.rs)
- CoherenceConfig (from config.rs)

API:
  new(&config) -> Self
  compute_coherence(&current, &history) -> f32
  update(&embedding)
  update_and_compute(&embedding) -> f32

Formula:
  coherence = (sim_weight * avg_sim) + (cons_weight * consistency)
  avg_sim = (cosine_sim + 1.0) / 2.0  // maps [-1,1] to [0,1]
  consistency = exp(-5.0 * avg_variance)
```
